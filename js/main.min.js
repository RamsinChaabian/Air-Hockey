window.matchInterval=null;let last=performance.now(),lastState=null;const rlAgent=new RLAgent,targetAgent=new RLAgent;rlAgent.updateTargetModel(targetAgent.model);let replayBuffer=[];const REPLAY_BUFFER_SIZE=1e4,TRAINING_BATCH_SIZE=64;let trainingStepCount=0;const TARGET_UPDATE_FREQUENCY_STEPS=1e3;let trainingEpisodeCount=0,totalReward=0;function initializeApp(){console.log("Initializing Air Hockey AI... Start a single player game or load a saved model."),resize(),resetObjects(),requestAnimationFrame(loop)}function startGame(e){const t=Number(matchMinutesSelect.value||2);modal.style.display="none",resize(),resetObjects(),tryFullscreen();try{"suspended"===audioCtx.state&&audioCtx.resume()}catch(e){console.error("Could not resume audio context:",e)}startMatch(t,e)}function startMatch(e,t){state.gameMode=t,state.goldenGoal=!1,timerEl.classList.remove("golden-goal-text"),playerALabel.textContent="singlePlayer"===t||"ai-vs-ai"===t?"Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ":"Ø¨Ø§Ø²ÛŒÚ©Ù† â†",startCrowd(),state.matchTime=Math.max(10,Math.floor(60*e)),state.timeLeft=state.matchTime,state.running=!1,state.paused=!1,state.scoreA=0,state.scoreB=0,scoreAEl.textContent=0,scoreBEl.textContent=0,timerEl.textContent=formatTime(state.timeLeft),lastTouch=null,totalReward=0,messageOverlay.classList.remove("show"),window.matchInterval&&clearInterval(window.matchInterval);let a=3;!function e(){a>0?(showMessage(a,"white"),playClick(440,.1,.2),a--,setTimeout(e,1e3)):(showMessage("Ø´Ø±ÙˆØ¹!","#ffd166"),playWhistle(),state.running=!0,"singlePlayer"!==state.gameMode&&"ai-vs-ai"!==state.gameMode||(lastState=getGameState()),window.matchInterval=setInterval((()=>{!state.running||state.paused||state.goldenGoal||(state.timeLeft-=1,timerEl.textContent=formatTime(state.timeLeft),state.timeLeft<=10&&state.timeLeft>0&&(showMessage(state.timeLeft,"#FFD700"),playClick(1200,.1,.4)),state.timeLeft<=0&&handleTimeUp())}),1e3))}()}function handleTimeUp(){state.scoreA===state.scoreB?(state.goldenGoal=!0,state.running=!0,window.matchInterval&&clearInterval(window.matchInterval),timerEl.textContent="Ú¯Ù„ Ø·Ù„Ø§ÛŒÛŒ",timerEl.classList.add("golden-goal-text"),messageOverlay.innerHTML='<div class="golden-goal-text">Ú¯Ù„ Ø·Ù„Ø§ÛŒÛŒ</div>',messageOverlay.classList.add("show"),setTimeout((()=>messageOverlay.classList.remove("show")),2500),playWhistle()):endMatch()}function togglePause(){state.running&&(state.paused=!state.paused,state.paused?(stopCrowd(),showPauseMenu()):(startCrowd(),modal.style.display="none",last=performance.now(),requestAnimationFrame(loop)))}function calculateReward(e,t){if(e)return 50;if(t)return-50;let a=0;const{left:n,right:s,top:o,bottom:l,width:i}=tableCoords(canvas.width,canvas.height),d={x:n,y:(o+l)/2};a+=.8*(1-distance(paddleA,puck)/i);a+=distance(puck,d)/i*.4;const r=1.5*paddleA.r,c=paddleA.y<o+r||paddleA.y>l+r||paddleA.x<n+r,g=Math.hypot(paddleA.vx,paddleA.vy)<50;if(c&&g&&(a-=.5),puck.x<n+i/2){const e={x:d.x-puck.x,y:d.y-puck.y},t=Math.hypot(e.x,e.y)||1,n={x:puck.x+e.x/t*(2*paddleA.r),y:puck.y+e.y/t*(2*paddleA.r)};a+=.3*(1-distance(paddleA,n)/i)}if("A"===lastTouch){const e={x:s,y:(o+l)/2},t=puck.vx*(e.x-puck.x);t>0&&(a+=t/(i*puck.maxSpeed)*1.5)}return a}async function loop(e){if(state.paused)return void requestAnimationFrame(loop);const t=Math.min(.03,(e-last)/1e3);last=e;const a=state.scoreA,n=state.scoreB;state.running&&(handleGamepadInput(t),stepPhysics(t));let s=state.scoreA>a,o=state.scoreB>n,l=s||o||state.timeLeft<=0&&!state.goldenGoal;if(state.running&&("singlePlayer"===state.gameMode||"ai-vs-ai"===state.gameMode)&&lastState){trainingStepCount++;const e=calculateReward(s,o,lastAction);totalReward+=e;const t=getGameState();if(replayBuffer.push({state:lastState,action:lastAction,reward:e,nextState:t,done:l}),replayBuffer.length>REPLAY_BUFFER_SIZE&&replayBuffer.shift(),lastState=t,l&&(trainingEpisodeCount++,console.group(`%c--- Episode ${trainingEpisodeCount} Finished ---`,"color: yellow; font-size: 14px;"),console.log("%cReason: "+(s?"AI Scored!":o?"Player Scored":"Time Up"),"color: "+(s?"lightgreen":"orange")),console.log(`Total Reward in Episode: ${totalReward.toFixed(2)}`),replayBuffer.length<TRAINING_BATCH_SIZE&&console.log(`Collecting experiences... ${replayBuffer.length}/${TRAINING_BATCH_SIZE}`),console.log(`ðŸ§  AI Status: Exploration (Epsilon) = ${rlAgent.epsilon.toFixed(4)}`),console.groupEnd(),totalReward=0),trainingStepCount%4==0&&replayBuffer.length>=TRAINING_BATCH_SIZE){const e=[];for(let t=0;t<TRAINING_BATCH_SIZE;t++){const t=Math.floor(Math.random()*replayBuffer.length);e.push(replayBuffer[t])}rlAgent.train(e,targetAgent.model)}trainingStepCount%TARGET_UPDATE_FREQUENCY_STEPS==0&&trainingStepCount>0&&(rlAgent.updateTargetModel(targetAgent.model),console.log(`%cðŸŽ¯ Target Model Updated after ${trainingStepCount} steps!`,"color: cyan; font-weight: bold;"))}let i=0,d=0;shakeTimer>0&&(i=(Math.random()-.5)*shakeIntensity,d=(Math.random()-.5)*shakeIntensity,ctx.translate(i,d),shakeTimer-=t,shakeIntensity*=.95),draw(t),shakeTimer>0&&ctx.translate(-i,-d),requestAnimationFrame(loop)}window.addEventListener("resize",(()=>{resize(),resetObjects()})),fsBtn.addEventListener("click",tryFullscreen),startSinglePlayerBtn.addEventListener("click",(()=>startGame("singlePlayer"))),startTwoPlayerBtn.addEventListener("click",(()=>startGame("twoPlayer")));const startAiVsAiBtn=document.getElementById("startAiVsAiBtn");startAiVsAiBtn&&startAiVsAiBtn.addEventListener("click",(()=>startGame("ai-vs-ai"))),pauseBtn.addEventListener("click",togglePause),resetBtn.addEventListener("click",(()=>location.reload()));const saveAiBtn=document.getElementById("saveAiBtn"),loadAiBtn=document.getElementById("loadAiBtn"),loadAiModal=document.getElementById("loadAiModal"),selectFilesBtn=document.getElementById("selectFilesBtn"),confirmLoadBtn=document.getElementById("confirmLoadBtn"),cancelLoadBtn=document.getElementById("cancelLoadBtn"),modelUploader=document.getElementById("modelUploader"),fileStatusEl=document.getElementById("fileStatus");let stagedFiles=[];function checkFilesReady(){const e=stagedFiles.some((e=>e.name.endsWith(".json"))),t=stagedFiles.some((e=>e.name.endsWith(".bin"))),a=stagedFiles.some((e=>e.name.endsWith(".txt"))),n=e&&t&&a;fileStatusEl.textContent=n?`${stagedFiles.length} ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯ âœ”ï¸`:"Ù„Ø·ÙØ§Ù‹ Û³ ÙØ§ÛŒÙ„ Ù…Ø¯Ù„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ âŒ",fileStatusEl.style.color=n?"#02ffa0":"#ff6b6b",confirmLoadBtn.disabled=!n,confirmLoadBtn.style.opacity=n?1:.5}saveAiBtn&&saveAiBtn.addEventListener("click",(()=>{"singlePlayer"===state.gameMode||"ai-vs-ai"===state.gameMode?rlAgent.saveModel():showMessage("ÙÙ‚Ø· Ø¯Ø± Ø­Ø§Ù„Øª ØªÚ©â€ŒÙ†ÙØ±Ù‡ ÛŒØ§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø± Ù…Ù‚Ø§Ø¨Ù„ Ø±Ø¨Ø§Øª!","orange")})),loadAiBtn&&loadAiBtn.addEventListener("click",(()=>{loadAiModal.style.display="flex",stagedFiles=[],modelUploader.value="",checkFilesReady()})),selectFilesBtn.addEventListener("click",(()=>modelUploader.click())),modelUploader.addEventListener("change",(e=>{stagedFiles=Array.from(e.target.files),checkFilesReady()})),confirmLoadBtn.addEventListener("click",(async()=>{await rlAgent.loadModel(stagedFiles)&&(rlAgent.updateTargetModel(targetAgent.model),loadAiModal.style.display="none")})),cancelLoadBtn.addEventListener("click",(()=>{loadAiModal.style.display="none"})),window.addEventListener("keydown",(e=>{"Escape"!==e.key&&"p"!==e.key.toLowerCase()||togglePause(),keys[e.key.toLowerCase()]=!0,keys[e.code]=!0,handleShootKeydown(e)})),window.addEventListener("keyup",(e=>{keys[e.key.toLowerCase()]=!1,keys[e.code]=!1})),canvas.addEventListener("touchstart",(e=>{e.preventDefault();for(const t of e.changedTouches)activeTouch[t.identifier]={id:t.identifier}}),{passive:!1}),canvas.addEventListener("touchmove",(e=>{if(e.preventDefault(),!state.running||state.paused)return;const t=canvas.getBoundingClientRect();for(const a of e.changedTouches){const e={x:a.clientX-t.left,y:a.clientY-t.top},n=distance(e,paddleA),s=distance(e,paddleB);"twoPlayer"===state.gameMode&&n<s?(paddleA.x=e.x,paddleA.y=e.y):(paddleB.x=e.x,paddleB.y=e.y)}}),{passive:!1}),window.addEventListener("orientationchange",(()=>{resize(),resetObjects()})),document.addEventListener("selectstart",(e=>e.preventDefault())),initializeApp();