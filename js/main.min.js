window.matchInterval=null;let last=performance.now(),lastState=null;const rlAgent=new RLAgent,targetAgent=new RLAgent;rlAgent.updateTargetModel(targetAgent.model);let replayBuffer=[];const REPLAY_BUFFER_SIZE=1e4,TRAINING_BATCH_SIZE=64;let trainingEpisodeCount=0,totalReward=0;const TARGET_UPDATE_FREQUENCY=10;function initializeApp(){console.log("Initializing Air Hockey AI... Start a single player game or load a saved model."),resize(),resetObjects(),requestAnimationFrame(loop)}function startGame(e){const t=Number(matchMinutesSelect.value||2);modal.style.display="none",resize(),resetObjects(),tryFullscreen();try{"suspended"===audioCtx.state&&audioCtx.resume()}catch(e){console.error("Could not resume audio context:",e)}startMatch(t,e)}function startMatch(e,t){state.gameMode=t,state.goldenGoal=!1,timerEl.classList.remove("golden-goal-text"),playerALabel.textContent="singlePlayer"===t?"هوش مصنوعی":"بازیکن ←",startCrowd(),state.matchTime=Math.max(10,Math.floor(60*e)),state.timeLeft=state.matchTime,state.running=!1,state.paused=!1,state.scoreA=0,state.scoreB=0,scoreAEl.textContent=0,scoreBEl.textContent=0,timerEl.textContent=formatTime(state.timeLeft),lastTouch=null,totalReward=0,messageOverlay.classList.remove("show"),window.matchInterval&&clearInterval(window.matchInterval);let n=3;!function e(){n>0?(showMessage(n,"white"),playClick(440,.1,.2),n--,setTimeout(e,1e3)):(showMessage("شروع!","#ffd166"),playWhistle(),state.running=!0,"singlePlayer"===state.gameMode&&(lastState=getGameState()),window.matchInterval=setInterval((()=>{!state.running||state.paused||state.goldenGoal||(state.timeLeft-=1,timerEl.textContent=formatTime(state.timeLeft),state.timeLeft<=10&&state.timeLeft>0&&(showMessage(state.timeLeft,"#FFD700"),playClick(1200,.1,.4)),state.timeLeft<=0&&handleTimeUp())}),1e3))}()}function handleTimeUp(){state.scoreA===state.scoreB?(state.goldenGoal=!0,state.running=!0,window.matchInterval&&clearInterval(window.matchInterval),timerEl.textContent="گل طلایی",timerEl.classList.add("golden-goal-text"),messageOverlay.innerHTML='<div class="golden-goal-text">گل طلایی</div>',messageOverlay.classList.add("show"),setTimeout((()=>messageOverlay.classList.remove("show")),2500),playWhistle()):endMatch()}function togglePause(){state.running&&(state.paused=!state.paused,state.paused?(stopCrowd(),showPauseMenu()):(startCrowd(),modal.style.display="none",last=performance.now(),requestAnimationFrame(loop)))}function calculateReward(e,t){if(e)return 100;if(t)return-100;let n=0;return n+=.1*(1-distance(paddleA,puck)/canvas.width),"A"===lastTouch&&(n+=1),n}async function loop(e){if(state.paused)return void requestAnimationFrame(loop);const t=Math.min(.03,(e-last)/1e3);last=e;const n=state.scoreA,a=state.scoreB;state.running&&(handleGamepadInput(t),stepPhysics(t));let s=state.scoreA>n,l=state.scoreB>a,o=s||l||state.timeLeft<=0&&!state.goldenGoal;if(state.running&&"singlePlayer"===state.gameMode&&lastState){const e=calculateReward(s,l);totalReward+=e;const t=getGameState();if(replayBuffer.push({state:lastState,action:lastAction,reward:e,nextState:t,done:o}),replayBuffer.length>REPLAY_BUFFER_SIZE&&replayBuffer.shift(),lastState=t,o){if(trainingEpisodeCount++,console.group(`%c--- Episode ${trainingEpisodeCount} Finished ---`,"color: yellow; font-size: 14px;"),console.log("%cReason: "+(s?"AI Scored!":l?"Player Scored":"Time Up"),"color: "+(s?"lightgreen":"orange")),console.log(`Total Reward in Episode: ${totalReward.toFixed(2)}`),replayBuffer.length>=TRAINING_BATCH_SIZE){const e=[];for(let t=0;t<TRAINING_BATCH_SIZE;t++){const t=Math.floor(Math.random()*replayBuffer.length);e.push(replayBuffer[t])}console.log("Training the brain with a batch of "+TRAINING_BATCH_SIZE+" experiences..."),await rlAgent.train(e,targetAgent.model)}else console.log(`Collecting experiences... ${replayBuffer.length}/${TRAINING_BATCH_SIZE}`);trainingEpisodeCount%TARGET_UPDATE_FREQUENCY==0&&(rlAgent.updateTargetModel(targetAgent.model),console.log("%c🎯 Target Model Updated!","color: cyan; font-weight: bold;")),console.log(`🧠 AI Status: Exploration (Epsilon) = ${rlAgent.epsilon.toFixed(4)}`),console.groupEnd(),totalReward=0}}let i=0,d=0;shakeTimer>0&&(i=(Math.random()-.5)*shakeIntensity,d=(Math.random()-.5)*shakeIntensity,ctx.translate(i,d),shakeTimer-=t,shakeIntensity*=.95),draw(t),shakeTimer>0&&ctx.translate(-i,-d),requestAnimationFrame(loop)}window.addEventListener("resize",(()=>{resize(),resetObjects()})),fsBtn.addEventListener("click",tryFullscreen),startSinglePlayerBtn.addEventListener("click",(()=>startGame("singlePlayer"))),startTwoPlayerBtn.addEventListener("click",(()=>startGame("twoPlayer"))),pauseBtn.addEventListener("click",togglePause),resetBtn.addEventListener("click",(()=>location.reload()));const saveAiBtn=document.getElementById("saveAiBtn"),loadAiBtn=document.getElementById("loadAiBtn"),loadAiModal=document.getElementById("loadAiModal"),selectJsonBtn=document.getElementById("selectJsonBtn"),selectBinBtn=document.getElementById("selectBinBtn"),selectTxtBtn=document.getElementById("selectTxtBtn"),confirmLoadBtn=document.getElementById("confirmLoadBtn"),cancelLoadBtn=document.getElementById("cancelLoadBtn"),jsonUploader=document.getElementById("jsonUploader"),binUploader=document.getElementById("binUploader"),txtUploader=document.getElementById("txtUploader");let stagedFiles={jsonFile:null,weightsFile:null,epsilonFile:null};function checkFilesReady(){const e=stagedFiles.jsonFile&&stagedFiles.weightsFile&&stagedFiles.epsilonFile;confirmLoadBtn.disabled=!e,confirmLoadBtn.style.opacity=e?1:.5}saveAiBtn&&saveAiBtn.addEventListener("click",(()=>{"singlePlayer"===state.gameMode?rlAgent.saveModel():showMessage("فقط در حالت تک‌نفره!","orange")})),loadAiBtn&&loadAiBtn.addEventListener("click",(()=>{loadAiModal.style.display="flex",stagedFiles={jsonFile:null,weightsFile:null,epsilonFile:null},document.getElementById("jsonStatus").textContent="❌",document.getElementById("binStatus").textContent="❌",document.getElementById("txtStatus").textContent="❌",checkFilesReady()})),selectJsonBtn.addEventListener("click",(()=>jsonUploader.click())),selectBinBtn.addEventListener("click",(()=>binUploader.click())),selectTxtBtn.addEventListener("click",(()=>txtUploader.click())),jsonUploader.addEventListener("change",(e=>{stagedFiles.jsonFile=e.target.files[0],document.getElementById("jsonStatus").textContent="✔️",checkFilesReady()})),binUploader.addEventListener("change",(e=>{stagedFiles.weightsFile=e.target.files[0],document.getElementById("binStatus").textContent="✔️",checkFilesReady()})),txtUploader.addEventListener("change",(e=>{stagedFiles.epsilonFile=e.target.files[0],document.getElementById("txtStatus").textContent="✔️",checkFilesReady()})),confirmLoadBtn.addEventListener("click",(async()=>{await rlAgent.loadModel(stagedFiles)&&(rlAgent.updateTargetModel(targetAgent.model),loadAiModal.style.display="none")})),cancelLoadBtn.addEventListener("click",(()=>{loadAiModal.style.display="none"})),window.addEventListener("keydown",(e=>{"Escape"!==e.key&&"p"!==e.key.toLowerCase()||togglePause(),keys[e.key.toLowerCase()]=!0,keys[e.code]=!0,handleShootKeydown(e)})),window.addEventListener("keyup",(e=>{keys[e.key.toLowerCase()]=!1,keys[e.code]=!1})),canvas.addEventListener("touchstart",(e=>{e.preventDefault();for(const t of e.changedTouches)activeTouch[t.identifier]={id:t.identifier}}),{passive:!1}),canvas.addEventListener("touchmove",(e=>{if(e.preventDefault(),!state.running||state.paused)return;const t=canvas.getBoundingClientRect();for(const n of e.changedTouches){const e={x:n.clientX-t.left,y:n.clientY-t.top},a=distance(e,paddleA),s=distance(e,paddleB);"twoPlayer"===state.gameMode&&a<s?(paddleA.x=e.x,paddleA.y=e.y):(paddleB.x=e.x,paddleB.y=e.y)}}),{passive:!1}),window.addEventListener("orientationchange",(()=>{resize(),resetObjects()})),document.addEventListener("selectstart",(e=>e.preventDefault())),initializeApp();