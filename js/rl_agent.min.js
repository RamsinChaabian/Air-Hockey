class RLAgent{constructor(){this.model=this.createModel(),this.learningRate=.001,this.discountFactor=.95,this.epsilon=1,this.epsilonDecay=.995,this.epsilonMin=.05}createModel(){const e=tf.sequential();return e.add(tf.layers.dense({inputShape:[13],units:64,activation:"relu"})),e.add(tf.layers.dense({units:64,activation:"relu"})),e.add(tf.layers.dense({units:13,activation:"linear"})),e.compile({optimizer:tf.train.adam(this.learningRate),loss:"meanSquaredError"}),e}chooseAction(e){return Math.random()<=this.epsilon?Math.floor(13*Math.random()):tf.tidy((()=>this.model.predict(tf.tensor2d([e])).argMax(1).dataSync()[0]))}async train(e,t){if(e.length<TRAINING_BATCH_SIZE)return;const o=e.map((e=>e.state)),s=e.map((e=>e.action)),n=e.map((e=>e.reward)),i=e.map((e=>e.nextState)),a=e.map((e=>e.done)),r=tf.tensor2d(o,[e.length,13]),l=tf.tensor1d(s,"int32"),d=tf.tensor1d(n,"float32"),c=tf.tensor2d(i,[e.length,13]),h=tf.tensor1d(a,"bool"),m=t.predict(c),f=m.max(1),p=h.logicalNot(),u=d.add(f.mul(this.discountFactor).mul(p)),g=this.model.predict(r),w=tf.oneHot(l,13),y=tf.sub(1,w),M=g.mul(y).add(w.mul(u.expandDims(1)));await this.model.fit(r,M,{epochs:1,verbose:0,callbacks:{onTrainEnd:()=>{tf.dispose([r,l,d,c,h,m,f,p,u,g,w,y,M])}}}),this.epsilon>this.epsilonMin&&(this.epsilon*=this.epsilonDecay)}updateTargetModel(e){e.setWeights(this.model.getWeights())}async saveModel(){await this.model.save("downloads://air-hockey-ai-model");const e=new Blob([this.epsilon.toString()],{type:"text/plain"}),t=window.URL.createObjectURL(e),o=document.createElement("a");o.style.display="none",o.href=t,o.download="air-hockey-ai-epsilon.txt",document.body.appendChild(o),o.click(),window.URL.revokeObjectURL(t),o.remove(),console.log("%cAI Model and Epsilon Saved for Download!","color: lightgreen; font-weight: bold;"),showMessage("فایل‌های هوش مصنوعی آماده دانلود!","#02ffa0")}async loadModel(e){if(!e||e.length<3)return showMessage("لطفاً هر سه فایل مدل را انتخاب کنید!","red"),!1;const t=e.find((e=>e.name.endsWith(".json"))),o=e.find((e=>e.name.endsWith(".bin"))),s=e.find((e=>e.name.endsWith(".txt")));if(!t||!o||!s)return console.error("One or more required model files are missing from the selection."),showMessage("فایل‌های JSON, BIN, یا TXT در انتخاب شما یافت نشد!","red"),!1;try{this.model=await tf.loadLayersModel(tf.io.browserFiles([t,o])),this.model.compile({optimizer:tf.train.adam(this.learningRate),loss:"meanSquaredError"});const e=await s.text();return this.epsilon=parseFloat(e),console.log("%cAI Model Loaded Successfully from files!","color: cyan; font-weight: bold;"),showMessage("هوش مصنوعی بارگذاری شد!","#56ccf2"),!0}catch(e){return console.error("Error loading model from files:",e),showMessage("خطا در بارگذاری فایل!","red"),!1}}}