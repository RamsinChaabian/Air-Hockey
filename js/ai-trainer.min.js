const rlAgent=new RLAgent,targetAgent=new RLAgent;rlAgent.updateTargetModel(targetAgent.model);let replayBuffer=[];const REPLAY_BUFFER_SIZE=1e4,TRAINING_BATCH_SIZE=64;let trainingStepCount=0;const TARGET_UPDATE_FREQUENCY_STEPS=1e3;let trainingEpisodeCount=0,totalReward=0,episodeRewardDetails={},performanceTracker=[];const CONSECUTIVE_EPISODES_FOR_RESET=25,REWARD_THRESHOLD=-10;function calculateRewardWithDetails(e,t,o){const a={};let n=0;if(e)return a["Ú¯Ù„ Ø²Ø¯Ù‡"]=50,{total:50,details:a};if(t)return a["Ú¯Ù„ Ø®ÙˆØ±Ø¯Ù‡"]=-50,{total:-50,details:a};if(o)return a["Ù¾Ù†Ø§Ù„ØªÛŒ (Ø§ÙˆØª)"]=-25,{total:-25,details:a};const{left:l,right:r,top:i,bottom:s,width:c,height:d}=tableCoords(canvas.width,canvas.height),g=l+.15*c,p=.2*d;if(paddleA.x<g||paddleA.y<i+p||paddleA.y>s-p){const e=-.8;n+=e,a["Ø¬Ø±ÙŠÙ…Ù‡ Ú¯ÙˆØ´Ù‡"]=e}else{const e=.4*(1-Math.abs(paddleA.y-(i+s)/2)/(d/2));n+=e,a["Ú©Ù†ØªØ±Ù„ Ù…Ø±Ú©Ø²"]=e;const t=.2*(1-distance(paddleA,puck)/c);n+=t,a["Ù†Ø²Ø¯ÛŒÚ©ÛŒ Ø¨Ù‡ ØªÙˆÙ¾"]=t;const o=.8*((puck.x-l)/c);if(n+=o,a["Ù¾ÛŒØ´Ø±ÙˆÛŒ ØªÙˆÙ¾"]=o,"A"===lastTouch){const e={x:r,y:(i+s)/2},t=puck.vx*(e.x-puck.x);if(t>0){const e=t/(c*puck.maxSpeed)*1.5;n+=e,a["Ø´ÙˆØª Ù…ÙˆØ«Ø±"]=e}}}return{total:n,details:a}}function trainAI(e,t,o){if(state.running&&("singlePlayer"===state.gameMode||"ai-vs-ai"===state.gameMode)&&lastState){trainingStepCount++;const{total:a,details:n}=calculateRewardWithDetails(e,t,o);for(const e in n)episodeRewardDetails[e]=(episodeRewardDetails[e]||0)+n[e];totalReward+=a;const l=getGameState(),r=e||t||state.timeLeft<=0&&!state.goldenGoal;if(replayBuffer.push({state:lastState,action:lastAction,reward:a,nextState:l,done:r}),replayBuffer.length>1e4&&replayBuffer.shift(),lastState=l,r){trainingEpisodeCount++,console.group(`%c--- Episode ${trainingEpisodeCount} Finished ---`,"color: yellow; font-size: 14px;"),console.log("%cReason: "+(e?"AI Scored!":t?"Player Scored":"Time Up"),"color: "+(e?"lightgreen":"orange")),console.log(`Total Reward in Episode: ${totalReward.toFixed(2)}`),console.log("%cAggregated Reward Details for the Episode:","color: lightblue; font-weight: bold;");const o=Object.entries(episodeRewardDetails).sort((([,e],[,t])=>e-t)).reduce(((e,[t,o])=>({...e,[t]:o.toFixed(2)})),{});console.table(o),totalReward<-10?performanceTracker.push(!0):performanceTracker=[],performanceTracker.length>=25&&(rlAgent.epsilon=Math.max(rlAgent.epsilon,.4),console.log("%cðŸ§  AI stuck in local minimum! Resetting epsilon to force exploration.","color: orange; font-weight: bold;"),performanceTracker=[]),replayBuffer.length<64&&console.log(`Collecting experiences... ${replayBuffer.length}/64`),console.log(`ðŸ§  AI Status: Exploration (Epsilon) = ${rlAgent.epsilon.toFixed(4)}`),console.groupEnd(),totalReward=0,episodeRewardDetails={}}if(trainingStepCount%4==0&&replayBuffer.length>=64){const e=[];for(let t=0;t<64;t++){const t=Math.floor(Math.random()*replayBuffer.length);e.push(replayBuffer[t])}rlAgent.train(e,targetAgent.model)}trainingStepCount%1e3==0&&trainingStepCount>0&&(rlAgent.updateTargetModel(targetAgent.model),console.log(`%cðŸŽ¯ Target Model Updated after ${trainingStepCount} steps!`,"color: cyan; font-weight: bold;"))}}