function resetObjects(){const{left:t,right:e,top:a,bottom:o,width:c}=tableCoords(canvas.width,canvas.height);puck={x:(t+e)/2,y:(a+o)/2,r:Math.max(12,Math.min(28,.02*c)),vx:0,vy:0,mass:1,maxSpeed:1500,rotation:0,angularVelocity:0},paddleA={x:t+.15*c,y:(a+o)/2,r:Math.max(22,Math.min(44,.03*c)),mass:5,maxSpeed:900,acceleration:3500,vx:0,vy:0,hitAnimation:0,isTurboActive:!1},paddleB={x:e-.15*c,y:(a+o)/2,r:Math.max(22,Math.min(44,.03*c)),mass:5,maxSpeed:900,acceleration:3500,vx:0,vy:0,hitAnimation:0,isTurboActive:!1},lastTouch=null}function attemptShoot(t,e={}){const a=e.who||"B";if("A"===a&&"twoPlayer"!==state.gameMode&&shoot.cooldownA>0||"B"===a&&shoot.cooldownB>0||"AI"===a&&shoot.aiCooldown>0)return;if(distance(puck,t)>t.r+puck.r+shoot.distance)return;let o,c=e.targetVec?normalize(e.targetVec):normalize({x:puck.x-t.x,y:puck.y-t.y});if("AI"===a)o=shoot.powerAI;else{const e=Math.hypot(t.vx,t.vy);o=shoot.basePowerHuman+e*shoot.velocityPowerMultiplier,t.isTurboActive&&(o*=turbo.powerMultiplier)}const l=.18;puck.vx=puck.vx*l+c.x*o*(1-l),puck.vy=puck.vy*l+c.y*o*(1-l);const d=Math.hypot(puck.vx,puck.vy),i=1.1*puck.maxSpeed;if(d>i){const t=i/d;puck.vx*=t,puck.vy*=t}puck.angularVelocity+=.002*(t.vx*c.y-t.vy*c.x)+(.4*Math.random()-.2),playShoot(),shakeTimer=.22,shakeIntensity=3+o/shoot.powerAI*6,"A"===a&&(shoot.cooldownA=shoot.cooldownHuman),"B"===a&&(shoot.cooldownB=shoot.cooldownHuman),"AI"===a&&(shoot.aiCooldown=shoot.cooldownAI)}function handleShootKeydown(t){state.running&&("ControlRight"===t.code&&attemptShoot(paddleB,{who:"B"}),t.key&&"f"===t.key.toLowerCase()&&"twoPlayer"===state.gameMode&&attemptShoot(paddleA,{who:"A"}))}function handleGamepadInput(t){if("ai-vs-ai"===state.gameMode)return;const e=navigator.getGamepads?navigator.getGamepads():[];if(!e.length)return;const a=(e,a)=>{if(!a)return;let o=e.acceleration;e.isTurboActive&&(o*=turbo.accelerationMultiplier);let c=a.axes[0],l=a.axes[1];Math.abs(c)<.1&&(c=0),Math.abs(l)<.1&&(l=0),e.vx+=c*o*t,e.vy+=l*o*t;const d=prevPad[a.index]?.buttons?.[0]||!1,i=!!a.buttons?.[0]?.pressed;if(i&&!d){attemptShoot(e,{who:e===paddleA?"A":"B"})}prevPad[a.index]=prevPad[a.index]||{buttons:[]},prevPad[a.index].buttons[0]=i},o=e[1]||e[0];if(a(paddleB,o),"twoPlayer"===state.gameMode){const t=e[0];!t||o&&t.index===o.index||a(paddleA,t)}}let lastAction=0;function getGameState(){const{left:t,right:e,top:a,bottom:o,width:c,height:l}=tableCoords(canvas.width,canvas.height);return[(puck.x-(t+c/2))/(c/2),(puck.y-(a+l/2))/(l/2),puck.vx/puck.maxSpeed,puck.vy/puck.maxSpeed,(paddleA.x-(t+c/4))/(c/4),(paddleA.y-(a+l/2))/(l/2),(paddleB.x-(e-c/4))/(c/4),(paddleB.y-(a+l/2))/(l/2)]}function aiControlRL(t){const{left:e,top:a,bottom:o,width:c}=tableCoords(canvas.width,canvas.height),l=paddleA.acceleration*t,d=1.5*paddleA.r,i=paddleA.y<a+d,r=paddleA.y>o-d,n=paddleA.x<e+d,p=paddleA.x>e+c/2-d;if(i)return void(paddleA.vy+=1.5*l);if(r)return void(paddleA.vy-=1.5*l);if(n)return void(paddleA.vx+=1.5*l);if(p)return void(paddleA.vx-=1.5*l);const s=getGameState(),x=rlAgent.chooseAction(s);switch(lastAction=x,x){case 0:paddleA.vy-=l;break;case 1:paddleA.vy+=l;break;case 2:paddleA.vx-=l;break;case 3:paddleA.vx+=l;break;case 4:attemptShoot(paddleA,{who:"AI"})}}function calculateBankShotTargetForBot(){const{left:t,right:e,top:a,bottom:o}=tableCoords(canvas.width,canvas.height),c={x:t+10,y:(a+o)/2};if(!(Math.abs(puck.y-paddleA.y)<paddleA.r&&puck.x>paddleA.x))return null;const l=[{y:a},{y:o}];for(const a of l){const o=a.y+(a.y-c.y),l={x:c.x,y:o},d=normalize({x:l.x-puck.x,y:l.y-puck.y}),i=(a.y-puck.y)/d.y;if(i>0){const o={x:puck.x+d.x*i,y:a.y};if(o.x>t&&o.x<e)return o}}return null}function aiControlHumanLike(t){const{left:e,right:a,top:o,bottom:c,width:l,height:d}=tableCoords(canvas.width,canvas.height),i=paddleB,r=Math.min(160,.32*d),n=(o+c)/2-r/2,p=(o+c)/2+r/2,s={x:e+10,y:(o+c)/2},x=puck.x>a-.55*l,h=()=>{i.x=Math.max(a-l/2+i.r,Math.min(a-i.r,i.x)),i.y=Math.max(o+i.r,Math.min(c-i.r,i.y))},u=a-.14*l,y=.9*i.maxSpeed;shoot.cooldownB=Math.max(0,shoot.cooldownB-t);const k={x:puck.x+.15*puck.vx,y:puck.y+.15*puck.vy};if(!x&&"A"!==state.penaltyFor){const e={x:u,y:clamp(k.y,o+i.r,c-i.r)};return moveTowards(i,e,y,t),void h()}let v=null,f=!1;const g=calculateBankShotTargetForBot();if(g&&"A"!==state.penaltyFor&&Math.random()<.4)v=g,f=!0;else{let t=(paddleA.y-n)/r<.5?s.y+r/4+Math.random()*(r/4):s.y-r/4-Math.random()*(r/4);const e=clamp(t,n+12,p-12);v={x:s.x,y:e}}const m=normalize({x:v.x-k.x,y:v.y-k.y}),A=i.r+puck.r+(f?15:24),b={x:k.x-m.x*A,y:k.y-m.y*A};moveTowards(i,b,y,t,1.2);const w=normalize({x:puck.x-i.x,y:puck.y-i.y}),M=dot(w,m);distance(i,puck)<=i.r+puck.r+shoot.distance+6&&M>(f?.45:.55)&&shoot.cooldownB<=0&&attemptShoot(i,{who:"B",targetVec:m}),h()}function moveTowards(t,e,a,o,c=1){const l=e.x-t.x,d=e.y-t.y,i=Math.hypot(l,d);i>1&&(t.vx+=l/i*a*o*8*(c||1),t.vy+=d/i*a*o*8*(c||1)),t.vx*=.9,t.vy*=.9;const r=Math.hypot(t.vx,t.vy);if(r>a){const e=a/r;t.vx*=e,t.vy*=e}}function triggerPenalty(t){if(!state.running)return;const{left:e,right:a}=tableCoords(canvas.width,canvas.height);let o=t||(puck.x>(e+a)/2?"B":"A");state.penaltyFor||(showMessage("اوت","white"),playWhistle()),state.penaltyFor=o,puck.vx=puck.vy=puck.angularVelocity=0;const{top:c,bottom:l,width:d}=tableCoords(canvas.width,canvas.height),i=(c+l)/2;"A"===o?(puck.x=a-.25*d,paddleB.x=a-.15*d):puck.x=e+.25*d,paddleA.x=e+.15*d,puck.y=paddleA.y=paddleB.y=i,paddleA.vx=paddleA.vy=paddleB.vx=paddleB.vy=0}function stepPhysics(t){const{left:e,right:a,top:o,bottom:c,width:l,height:d}=tableCoords(canvas.width,canvas.height),i=navigator.getGamepads?navigator.getGamepads():[],r=i[1]||i[0],n="twoPlayer"===state.gameMode&&i[0]?i[0]:null;if(paddleB&&"ai-vs-ai"!==state.gameMode){const t=!!r&&!!r.buttons?.[5]?.pressed,e=!!keys.ShiftRight;paddleB.isTurboActive=t||e}if(paddleA&&"twoPlayer"===state.gameMode){const t=!!(n&&(!r||n.index!==r.index))&&!!n.buttons?.[5]?.pressed,e=!!keys.ShiftLeft;paddleA.isTurboActive=t||e}const p=puck.r+20;if(distance(puck,{x:e,y:o})<p||distance(puck,{x:e,y:c})<p||distance(puck,{x:a,y:o})<p||distance(puck,{x:a,y:c})<p)return void triggerPenalty(lastTouch);const s=(e,a,o,c,l)=>{if("A"===state.penaltyFor&&e===paddleA||"B"===state.penaltyFor&&e===paddleB)e.vx*=.9,e.vy*=.9;else{let d=e.acceleration,i=e.maxSpeed;e.isTurboActive&&(d*=turbo.accelerationMultiplier,i*=turbo.maxSpeedMultiplier);let r=0,n=0;if(keys[a]&&(n-=1),keys[o]&&(n+=1),keys[c]&&(r-=1),keys[l]&&(r+=1),0!==r||0!==n){const a=Math.hypot(r,n);e.vx+=r/a*d*t,e.vy+=n/a*d*t}else e.vx*=.94,e.vy*=.94;const p=Math.hypot(e.vx,e.vy);if(p>i){const t=i/p;e.vx*=t,e.vy*=t}}};"twoPlayer"===state.gameMode?s(paddleA,"w","s","a","d"):aiControlRL(t),"ai-vs-ai"===state.gameMode?aiControlHumanLike(t):s(paddleB,"arrowup","arrowdown","arrowleft","arrowright"),paddleA.x+=paddleA.vx*t,paddleA.y+=paddleA.vy*t,paddleA.x=clamp(paddleA.x,e+paddleA.r,e+l/2-paddleA.r),paddleA.y=clamp(paddleA.y,o+paddleA.r,c-paddleA.r),paddleB.x+=paddleB.vx*t,paddleB.y+=paddleB.vy*t,paddleB.x=clamp(paddleB.x,e+l/2+paddleB.r,a-paddleB.r),paddleB.y=clamp(paddleB.y,o+paddleB.r,c-paddleB.r),puck.x+=puck.vx*t,puck.y+=puck.vy*t,puck.rotation+=puck.angularVelocity*t;const x=.995**(60*t);puck.vx*=x,puck.vy*=x,puck.angularVelocity*=x,puck.y-puck.r<o&&(puck.y=o+puck.r,puck.vy*=-.9,playClick(600)),puck.y+puck.r>c&&(puck.y=c-puck.r,puck.vy*=-.9,playClick(600));const h=Math.min(160,.32*d),u=(o+c)/2-h/2,y=(o+c)/2+h/2;puck.x-puck.r<=e&&(puck.y>u&&puck.y<y?scorePoint("B"):(puck.x=e+puck.r,puck.vx*=-.9,playClick(440))),puck.x+puck.r>=a&&(puck.y>u&&puck.y<y?scorePoint("A"):(puck.x=a-puck.r,puck.vx*=-.9,playClick(440)));const k=t=>{const e=puck.x-t.x,a=puck.y-t.y,o=Math.hypot(e,a),c=puck.r+t.r;if(o<c){t.hitAnimation=.2,playClick(1200,.05,.15),lastTouch=t===paddleA?"A":"B",state.penaltyFor&&("A"===state.penaltyFor&&t===paddleB||"B"===state.penaltyFor&&t===paddleA)&&(state.penaltyFor=null);const l=e/o,d=a/o;puck.x=t.x+l*c,puck.y=t.y+d*c;const i=(puck.vx-t.vx)*l+(puck.vy-t.vy)*d;if(i<0){const e=-1.3*i/(1/puck.mass+1/t.mass);puck.vx+=e*l/puck.mass,puck.vy+=e*d/puck.mass,puck.angularVelocity+=.002*(t.vx*d-t.vy*l);const a=Math.hypot(puck.vx,puck.vy);if(a>puck.maxSpeed){const t=puck.maxSpeed/a;puck.vx*=t,puck.vy*=t}}}};k(paddleA),k(paddleB),shoot.cooldownA=Math.max(0,shoot.cooldownA-t),shoot.cooldownB=Math.max(0,shoot.cooldownB-t)}function scorePoint(t){if(!state.running)return;if("A"===t?state.scoreA++:state.scoreB++,scoreAEl.textContent=state.scoreA,scoreBEl.textContent=state.scoreB,state.goldenGoal)return void endMatch();flashTimer=.5,flashSide=t,shakeTimer=.3,shakeIntensity=5,playCheer(.1),playWhistle();if(lastTouch&&lastTouch!==t)showMessage('<div style="text-align:center"><div id="lottieEmoji" style="width:100px; height:100px; margin:0 auto; display:block;"></div><div style="font-size:40px; margin-top:80px;">گل به خودی</div></div>',"white",!0);else{const e="A"===t?"#ff6b6b":"#ffd166";showMessage(String("A"===t?state.scoreA:state.scoreB),e)}const{left:e,right:a,top:o,bottom:c}=tableCoords(canvas.width,canvas.height);puck.x=(e+a)/2,puck.y=(o+c)/2,puck.vx="A"===t?-260:260,puck.vy=0,puck.angularVelocity=0,shoot.aiCooldown=.5,lastTouch=null}function drawPaddle(t,e,a,o){let c=t.r;if(t.hitAnimation>0){const e=1-t.hitAnimation/.2;c=t.r*(1+.2*Math.sin(e*Math.PI)),t.hitAnimation-=o}else t.hitAnimation=0;if(t.isTurboActive){ctx.beginPath(),ctx.arc(t.x,t.y,1.5*c,0,2*Math.PI);const a=ctx.createRadialGradient(t.x,t.y,c,t.x,t.y,1.5*c);a.addColorStop(0,`${e}88`),a.addColorStop(1,`${e}00`),ctx.fillStyle=a,ctx.fill()}const l=6+t.vx/t.maxSpeed*4,d=10+t.vy/t.maxSpeed*4;ctx.beginPath(),ctx.ellipse(t.x+l,t.y+d,1.1*c,.5*c,0,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.25)",ctx.fill(),ctx.beginPath(),ctx.arc(t.x,t.y,c,0,2*Math.PI);const i=ctx.createRadialGradient(t.x-.4*c,t.y-.4*c,.1*c,t.x,t.y,c);i.addColorStop(0,"rgba(255,255,255,0.8)"),i.addColorStop(.3,e),i.addColorStop(1,a),ctx.fillStyle=i,ctx.fill(),ctx.beginPath(),ctx.arc(t.x-.2*c,t.y-.2*c,.5*c,0,2*Math.PI);const r=ctx.createRadialGradient(t.x-.3*c,t.y-.3*c,0,t.x-.2*c,t.y-.2*c,.5*c);r.addColorStop(0,"rgba(255,255,255,0.7)"),r.addColorStop(1,"rgba(255,255,255,0)"),ctx.fillStyle=r,ctx.fill(),ctx.beginPath(),ctx.arc(t.x,t.y,c,0,2*Math.PI),ctx.strokeStyle="rgba(0,0,0,0.2)",ctx.lineWidth=3,ctx.stroke()}function drawPuck(){const t=4+puck.vx/puck.maxSpeed*6,e=8+puck.vy/puck.maxSpeed*6;ctx.beginPath(),ctx.ellipse(puck.x+t,puck.y+e,1.2*puck.r,.5*puck.r,0,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.26)",ctx.fill(),ctx.save(),ctx.translate(puck.x,puck.y),ctx.rotate(puck.rotation),ctx.beginPath(),ctx.arc(0,0,puck.r,0,2*Math.PI);const a=ctx.createRadialGradient(.3*-puck.r,.3*-puck.r,0,0,0,puck.r);a.addColorStop(0,"#f0f0f0"),a.addColorStop(.5,"#444"),a.addColorStop(1,"#111"),ctx.fillStyle=a,ctx.fill(),ctx.beginPath(),ctx.arc(0,0,puck.r,0,2*Math.PI),ctx.lineWidth=2,ctx.strokeStyle="rgba(0,0,0,0.4)",ctx.stroke(),ctx.beginPath(),ctx.arc(0,0,.6*puck.r,0,2*Math.PI),ctx.strokeStyle="rgba(255,255,255,0.2)",ctx.lineWidth=1.5,ctx.stroke(),ctx.restore()}function draw(t){const e=canvas.width,a=canvas.height;ctx.clearRect(0,0,e,a);const o=ctx.createLinearGradient(0,0,0,a);o.addColorStop(0,"#011121"),o.addColorStop(1,"#032a3b"),ctx.fillStyle=o,ctx.fillRect(0,0,e,a);const{left:c,right:l,top:d,bottom:i,width:r,height:n}=tableCoords(e,a);ctx.save(),ctx.translate(c+r/2,(d+i)/2+.05*n);const p=1.04*r,s=1.12*n,x=ctx.createRadialGradient(0,0,.02*p,0,0,.6*p);x.addColorStop(0,"rgba(0,0,0,0.55)"),x.addColorStop(1,"rgba(0,0,0,0)"),ctx.fillStyle=x,ctx.beginPath(),ctx.ellipse(0,0,p/2,s/4,0,0,2*Math.PI),ctx.fill(),ctx.restore();const h=ctx.createLinearGradient(0,d,0,i);h.addColorStop(0,"#56ccf2"),h.addColorStop(1,"#0077b6"),ctx.fillStyle=h,roundRect(ctx,c,d,r,n,26),ctx.fill(),ctx.lineWidth=6,ctx.strokeStyle="rgba(255,255,255,0.08)",roundRect(ctx,c+3,d+3,r-6,n-6,22),ctx.stroke(),ctx.beginPath(),ctx.moveTo(c+r/2,d+12),ctx.lineTo(c+r/2,i-12),ctx.strokeStyle="rgba(255,255,255,0.06)",ctx.lineWidth=3,ctx.stroke();const u=.25*r,y=.7*n,k=(d+i)/2-y/2;ctx.strokeStyle="rgba(255, 255, 255, 0.15)",ctx.lineWidth=2,roundRect(ctx,c,k,u,y,15),ctx.stroke(),roundRect(ctx,l-u,k,u,y,15),ctx.stroke();ctx.fillStyle="rgba(153,255,153,0.18)",ctx.beginPath(),ctx.arc(c+.25*r,(d+i)/2,30,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc(l-.25*r,(d+i)/2,30,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc((c+l)/2,(d+i)/2,.1*r,0,2*Math.PI),ctx.strokeStyle="rgba(255,255,255,0.1)",ctx.stroke();const v=(puck?.r||12)+20;ctx.setLineDash([8,10]),ctx.strokeStyle="rgba(255, 100, 100, 0.6)",ctx.lineWidth=3,ctx.beginPath(),ctx.arc(c,d,v,0,.5*Math.PI),ctx.stroke(),ctx.beginPath(),ctx.arc(c,i,v,.5*-Math.PI,0),ctx.stroke(),ctx.beginPath(),ctx.arc(l,d,v,.5*Math.PI,Math.PI),ctx.stroke(),ctx.beginPath(),ctx.arc(l,i,v,Math.PI,1.5*Math.PI),ctx.stroke(),ctx.setLineDash([]);const f=Math.min(160,.32*n),g=(d+i)/2-f/2;if(ctx.fillStyle="rgba(0,0,0,0.12)",roundRect(ctx,c-6,g,12,f,6),ctx.fill(),ctx.fillStyle="rgba(153,255,153,0.6)",roundRect(ctx,c,g,6,f,4),ctx.fill(),ctx.fillStyle="rgba(153,255,153,0.6)",roundRect(ctx,l-6,g,6,f,6),ctx.fill(),drawPaddle(paddleA,"#ff6b6b","#731010",t),drawPaddle(paddleB,"#ffd166","#6a4f00",t),drawPuck(),flashTimer>0){const e=flashTimer/.5;ctx.fillStyle=`rgba(255, 255, 255, ${.7*e})`;const a="A"===flashSide?l:c-20;roundRect(ctx,a,g,20,f,6),ctx.fill(),flashTimer-=t}}