function resetObjects(){const{left:t,right:e,top:a,bottom:o,width:c}=tableCoords(canvas.width,canvas.height);puck={x:(t+e)/2,y:(a+o)/2,r:Math.max(12,Math.min(28,.02*c)),vx:0,vy:0,mass:1,maxSpeed:1500,rotation:0,angularVelocity:0},paddleA={x:t+.15*c,y:(a+o)/2,r:Math.max(22,Math.min(44,.03*c)),mass:5,maxSpeed:900,acceleration:3500,vx:0,vy:0,hitAnimation:0,isTurboActive:!1},paddleB={x:e-.15*c,y:(a+o)/2,r:Math.max(22,Math.min(44,.03*c)),mass:5,maxSpeed:900,acceleration:3500,vx:0,vy:0,hitAnimation:0,isTurboActive:!1},lastTouch=null}function attemptShoot(t,e={}){const a=e.who||"B";if("A"===a&&"twoPlayer"!==state.gameMode&&shoot.cooldownA>0||"B"===a&&shoot.cooldownB>0||"AI"===a&&shoot.aiCooldown>0)return;if(distance(puck,t)>t.r+puck.r+shoot.distance)return;let o,c=e.targetVec?normalize(e.targetVec):normalize({x:puck.x-t.x,y:puck.y-t.y});if("AI"===a)o=shoot.powerAI;else{const e=Math.hypot(t.vx,t.vy);o=shoot.basePowerHuman+e*shoot.velocityPowerMultiplier,t.isTurboActive&&(o*=turbo.powerMultiplier)}const l=.18;puck.vx=puck.vx*l+c.x*o*(1-l),puck.vy=puck.vy*l+c.y*o*(1-l);const d=Math.hypot(puck.vx,puck.vy),r=1.1*puck.maxSpeed;if(d>r){const t=r/d;puck.vx*=t,puck.vy*=t}puck.angularVelocity+=.002*(t.vx*c.y-t.vy*c.x)+(.4*Math.random()-.2),playShoot(),shakeTimer=.22,shakeIntensity=3+o/shoot.powerAI*6,"A"===a&&(shoot.cooldownA=shoot.cooldownHuman),"B"===a&&(shoot.cooldownB=shoot.cooldownHuman),"AI"===a&&(shoot.aiCooldown=shoot.cooldownAI)}function handleShootKeydown(t){state.running&&("ControlRight"===t.code&&attemptShoot(paddleB,{who:"B"}),t.key&&"f"===t.key.toLowerCase()&&"twoPlayer"===state.gameMode&&attemptShoot(paddleA,{who:"A"}))}function handleGamepadInput(t){if("ai-vs-ai"===state.gameMode)return;const e=navigator.getGamepads?navigator.getGamepads():[];if(!e.length)return;const a=(e,a)=>{if(!a)return;let o=e.acceleration;e.isTurboActive&&(o*=turbo.accelerationMultiplier);let c=a.axes[0],l=a.axes[1];Math.abs(c)<.1&&(c=0),Math.abs(l)<.1&&(l=0),e.vx+=c*o*t,e.vy+=l*o*t;const d=prevPad[a.index]?.buttons?.[0]||!1,r=!!a.buttons?.[0]?.pressed;if(r&&!d){attemptShoot(e,{who:e===paddleA?"A":"B"})}prevPad[a.index]=prevPad[a.index]||{buttons:[]},prevPad[a.index].buttons[0]=r},o=e[1]||e[0];if(a(paddleB,o),"twoPlayer"===state.gameMode){const t=e[0];!t||o&&t.index===o.index||a(paddleA,t)}}let lastAction=0;function getGameState(){const{left:t,right:e,top:a,bottom:o,width:c,height:l}=tableCoords(canvas.width,canvas.height);return[(puck.x-(t+c/2))/(c/2),(puck.y-(a+l/2))/(l/2),puck.vx/puck.maxSpeed,puck.vy/puck.maxSpeed,puck.angularVelocity/15,(paddleA.x-(t+c/4))/(c/4),(paddleA.y-(a+l/2))/(l/2),paddleA.vx/paddleA.maxSpeed,paddleA.vy/paddleA.maxSpeed,(paddleB.x-(e-c/4))/(c/4),(paddleB.y-(a+l/2))/(l/2),paddleB.vx/paddleB.maxSpeed,paddleB.vy/paddleB.maxSpeed]}function aiControlRL(t){const{right:e,top:a,bottom:o,height:c}=tableCoords(canvas.width,canvas.height),l=paddleA.acceleration*t,d=l*(1/Math.sqrt(2)),r=getGameState(),i=rlAgent.chooseAction(r);lastAction=i,paddleA.isTurboActive=!1;const n=a+.15*c,p={x:e,y:(a+o)/2},s={x:e,y:n},x={x:e,y:n+.7*c};switch(i){case 0:paddleA.vy-=l;break;case 1:paddleA.vy+=l;break;case 2:paddleA.vx-=l;break;case 3:paddleA.vx+=l;break;case 4:paddleA.vy-=d,paddleA.vx-=d;break;case 5:paddleA.vy-=d,paddleA.vx+=d;break;case 6:paddleA.vy+=d,paddleA.vx-=d;break;case 7:paddleA.vy+=d,paddleA.vx+=d;break;case 8:attemptShoot(paddleA,{who:"AI",targetVec:{x:p.x-puck.x,y:p.y-puck.y}});break;case 9:attemptShoot(paddleA,{who:"AI",targetVec:{x:s.x-puck.x,y:s.y-puck.y}});break;case 10:attemptShoot(paddleA,{who:"AI",targetVec:{x:x.x-puck.x,y:x.y-puck.y}});break;case 11:paddleA.isTurboActive=!0}}function calculateBankShotTargetForBot(){const{left:t,right:e,top:a,bottom:o}=tableCoords(canvas.width,canvas.height),c={x:t+10,y:(a+o)/2};if(!(Math.abs(puck.y-paddleA.y)<paddleA.r&&puck.x>paddleA.x))return null;const l=[{y:a},{y:o}];for(const a of l){const o=a.y+(a.y-c.y),l={x:c.x,y:o},d=normalize({x:l.x-puck.x,y:l.y-puck.y}),r=(a.y-puck.y)/d.y;if(r>0){const o={x:puck.x+d.x*r,y:a.y};if(o.x>t&&o.x<e)return o}}return null}function aiControlHumanLike(t){const{left:e,right:a,top:o,bottom:c,width:l,height:d}=tableCoords(canvas.width,canvas.height),r=paddleB,i=Math.min(160,.32*d),n=(o+c)/2-i/2,p=(o+c)/2+i/2,s={x:e+10,y:(o+c)/2},x=puck.x>a-.55*l,h=()=>{r.x=Math.max(a-l/2+r.r,Math.min(a-r.r,r.x)),r.y=Math.max(o+r.r,Math.min(c-r.r,r.y))},y=a-.14*l,u=.9*r.maxSpeed;shoot.cooldownB=Math.max(0,shoot.cooldownB-t);const k={x:puck.x+.15*puck.vx,y:puck.y+.15*puck.vy};if(!x&&"A"!==state.penaltyFor){const e={x:y,y:clamp(k.y,o+r.r,c-r.r)};return moveTowards(r,e,u,t),void h()}let v=null,g=!1;const m=calculateBankShotTargetForBot();if(m&&"A"!==state.penaltyFor&&Math.random()<.4)v=m,g=!0;else{let t=(paddleA.y-n)/i<.5?s.y+i/4+Math.random()*(i/4):s.y-i/4-Math.random()*(i/4);const e=clamp(t,n+12,p-12);v={x:s.x,y:e}}const A=normalize({x:v.x-k.x,y:v.y-k.y}),f=r.r+puck.r+(g?15:24),b={x:k.x-A.x*f,y:k.y-A.y*f};moveTowards(r,b,u,t,1.2);const w=normalize({x:puck.x-r.x,y:puck.y-r.y}),S=dot(w,A);distance(r,puck)<=r.r+puck.r+shoot.distance+6&&S>(g?.45:.55)&&shoot.cooldownB<=0&&attemptShoot(r,{who:"B",targetVec:A}),h()}function moveTowards(t,e,a,o,c=1){const l=e.x-t.x,d=e.y-t.y,r=Math.hypot(l,d);r>1&&(t.vx+=l/r*a*o*8*(c||1),t.vy+=d/r*a*o*8*(c||1)),t.vx*=.9,t.vy*=.9;const i=Math.hypot(t.vx,t.vy);if(i>a){const e=a/i;t.vx*=e,t.vy*=e}}function triggerPenalty(t){if(!state.running)return;const{left:e,right:a}=tableCoords(canvas.width,canvas.height);let o=t||(puck.x>(e+a)/2?"B":"A");state.penaltyFor||(showMessage("اوت","white"),playWhistle()),state.penaltyFor=o,puck.vx=puck.vy=puck.angularVelocity=0;const{top:c,bottom:l,width:d}=tableCoords(canvas.width,canvas.height),r=(c+l)/2;"A"===o?(puck.x=a-.25*d,paddleB.x=a-.15*d):puck.x=e+.25*d,paddleA.x=e+.15*d,puck.y=paddleA.y=paddleB.y=r,paddleA.vx=paddleA.vy=paddleB.vx=paddleB.vy=0}function stepPhysics(t){const{left:e,right:a,top:o,bottom:c,width:l,height:d}=tableCoords(canvas.width,canvas.height),r=navigator.getGamepads?navigator.getGamepads():[],i=r[1]||r[0],n="twoPlayer"===state.gameMode&&r[0]?r[0]:null;if(paddleB&&"ai-vs-ai"!==state.gameMode){const t=!!i&&!!i.buttons?.[5]?.pressed,e=!!keys.ShiftRight;paddleB.isTurboActive=t||e}if(paddleA&&"twoPlayer"===state.gameMode){const t=!!(n&&(!i||n.index!==i.index))&&!!n.buttons?.[5]?.pressed,e=!!keys.ShiftLeft;paddleA.isTurboActive=t||e}const p=puck.r+20;if(distance(puck,{x:e,y:o})<p||distance(puck,{x:e,y:c})<p||distance(puck,{x:a,y:o})<p||distance(puck,{x:a,y:c})<p)return void triggerPenalty(lastTouch);const s=(e,a,o,c,l)=>{if("A"===state.penaltyFor&&e===paddleA||"B"===state.penaltyFor&&e===paddleB)e.vx*=.9,e.vy*=.9;else{let d=e.acceleration,r=e.maxSpeed;e.isTurboActive&&(d*=turbo.accelerationMultiplier,r*=turbo.maxSpeedMultiplier);let i=0,n=0;if(keys[a]&&(n-=1),keys[o]&&(n+=1),keys[c]&&(i-=1),keys[l]&&(i+=1),0!==i||0!==n){const a=Math.hypot(i,n);e.vx+=i/a*d*t,e.vy+=n/a*d*t}else e.vx*=.94,e.vy*=.94;const p=Math.hypot(e.vx,e.vy);if(p>r){const t=r/p;e.vx*=t,e.vy*=t}}};"twoPlayer"===state.gameMode?s(paddleA,"w","s","a","d"):aiControlRL(t),"ai-vs-ai"===state.gameMode?aiControlHumanLike(t):s(paddleB,"arrowup","arrowdown","arrowleft","arrowright"),paddleA.x+=paddleA.vx*t,paddleA.y+=paddleA.vy*t,paddleA.x=clamp(paddleA.x,e+paddleA.r,e+l/2-paddleA.r),paddleA.y=clamp(paddleA.y,o+paddleA.r,c-paddleA.r),paddleB.x+=paddleB.vx*t,paddleB.y+=paddleB.vy*t,paddleB.x=clamp(paddleB.x,e+l/2+paddleB.r,a-paddleB.r),paddleB.y=clamp(paddleB.y,o+paddleB.r,c-paddleB.r),puck.x+=puck.vx*t,puck.y+=puck.vy*t,puck.rotation+=puck.angularVelocity*t;const x=.995**(60*t);puck.vx*=x,puck.vy*=x,puck.angularVelocity*=x,puck.y-puck.r<o&&(puck.y=o+puck.r,puck.vy*=-.9,playClick(600)),puck.y+puck.r>c&&(puck.y=c-puck.r,puck.vy*=-.9,playClick(600));const h=Math.min(160,.32*d),y=(o+c)/2-h/2,u=(o+c)/2+h/2;puck.x-puck.r<=e&&(puck.y>y&&puck.y<u?scorePoint("B"):(puck.x=e+puck.r,puck.vx*=-.9,playClick(440))),puck.x+puck.r>=a&&(puck.y>y&&puck.y<u?scorePoint("A"):(puck.x=a-puck.r,puck.vx*=-.9,playClick(440)));const k=t=>{const e=puck.x-t.x,a=puck.y-t.y,o=Math.hypot(e,a),c=puck.r+t.r;if(o<c){t.hitAnimation=.2,playClick(1200,.05,.15),lastTouch=t===paddleA?"A":"B",state.penaltyFor&&("A"===state.penaltyFor&&t===paddleB||"B"===state.penaltyFor&&t===paddleA)&&(state.penaltyFor=null);const l=e/o,d=a/o;puck.x=t.x+l*c,puck.y=t.y+d*c;const r=(puck.vx-t.vx)*l+(puck.vy-t.vy)*d;if(r<0){const e=-1.3*r/(1/puck.mass+1/t.mass);puck.vx+=e*l/puck.mass,puck.vy+=e*d/puck.mass,puck.angularVelocity+=.002*(t.vx*d-t.vy*l);const a=Math.hypot(puck.vx,puck.vy);if(a>puck.maxSpeed){const t=puck.maxSpeed/a;puck.vx*=t,puck.vy*=t}}}};k(paddleA),k(paddleB),shoot.cooldownA=Math.max(0,shoot.cooldownA-t),shoot.cooldownB=Math.max(0,shoot.cooldownB-t)}function scorePoint(t){if(!state.running)return;if("A"===t?state.scoreA++:state.scoreB++,scoreAEl.textContent=state.scoreA,scoreBEl.textContent=state.scoreB,state.goldenGoal)return void endMatch();flashTimer=.5,flashSide=t,shakeTimer=.3,shakeIntensity=5,playCheer(.1),playWhistle();if(lastTouch&&lastTouch!==t)showMessage('<div style="text-align:center"><div id="lottieEmoji" style="width:100px; height:100px; margin:0 auto; display:block;"></div><div style="font-size:40px; margin-top:80px;">گل به خودی</div></div>',"white",!0);else{const e="A"===t?"#ff6b6b":"#ffd166";showMessage(String("A"===t?state.scoreA:state.scoreB),e)}const{left:e,right:a,top:o,bottom:c}=tableCoords(canvas.width,canvas.height);puck.x=(e+a)/2,puck.y=(o+c)/2,puck.vx="A"===t?-260:260,puck.vy=0,puck.angularVelocity=0,shoot.aiCooldown=.5,lastTouch=null}function drawPaddle(t,e,a,o){let c=t.r;if(t.hitAnimation>0){const e=1-t.hitAnimation/.2;c=t.r*(1+.2*Math.sin(e*Math.PI)),t.hitAnimation-=o}else t.hitAnimation=0;if(t.isTurboActive){ctx.beginPath(),ctx.arc(t.x,t.y,1.5*c,0,2*Math.PI);const a=ctx.createRadialGradient(t.x,t.y,c,t.x,t.y,1.5*c);a.addColorStop(0,`${e}88`),a.addColorStop(1,`${e}00`),ctx.fillStyle=a,ctx.fill()}const l=6+t.vx/t.maxSpeed*4,d=10+t.vy/t.maxSpeed*4;ctx.beginPath(),ctx.ellipse(t.x+l,t.y+d,1.1*c,.5*c,0,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.25)",ctx.fill(),ctx.beginPath(),ctx.arc(t.x,t.y,c,0,2*Math.PI);const r=ctx.createRadialGradient(t.x-.4*c,t.y-.4*c,.1*c,t.x,t.y,c);r.addColorStop(0,"rgba(255,255,255,0.8)"),r.addColorStop(.3,e),r.addColorStop(1,a),ctx.fillStyle=r,ctx.fill(),ctx.beginPath(),ctx.arc(t.x-.2*c,t.y-.2*c,.5*c,0,2*Math.PI);const i=ctx.createRadialGradient(t.x-.3*c,t.y-.3*c,0,t.x-.2*c,t.y-.2*c,.5*c);i.addColorStop(0,"rgba(255,255,255,0.7)"),i.addColorStop(1,"rgba(255,255,255,0)"),ctx.fillStyle=i,ctx.fill(),ctx.beginPath(),ctx.arc(t.x,t.y,c,0,2*Math.PI),ctx.strokeStyle="rgba(0,0,0,0.2)",ctx.lineWidth=3,ctx.stroke()}function drawPuck(){const t=4+puck.vx/puck.maxSpeed*6,e=8+puck.vy/puck.maxSpeed*6;ctx.beginPath(),ctx.ellipse(puck.x+t,puck.y+e,1.2*puck.r,.5*puck.r,0,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.26)",ctx.fill(),ctx.save(),ctx.translate(puck.x,puck.y),ctx.rotate(puck.rotation),ctx.beginPath(),ctx.arc(0,0,puck.r,0,2*Math.PI);const a=ctx.createRadialGradient(.3*-puck.r,.3*-puck.r,0,0,0,puck.r);a.addColorStop(0,"#f0f0f0"),a.addColorStop(.5,"#444"),a.addColorStop(1,"#111"),ctx.fillStyle=a,ctx.fill(),ctx.beginPath(),ctx.arc(0,0,puck.r,0,2*Math.PI),ctx.lineWidth=2,ctx.strokeStyle="rgba(0,0,0,0.4)",ctx.stroke(),ctx.beginPath(),ctx.arc(0,0,.6*puck.r,0,2*Math.PI),ctx.strokeStyle="rgba(255,255,255,0.2)",ctx.lineWidth=1.5,ctx.stroke(),ctx.restore()}function draw(t){const e=canvas.width,a=canvas.height;ctx.clearRect(0,0,e,a);const o=ctx.createLinearGradient(0,0,0,a);o.addColorStop(0,"#011121"),o.addColorStop(1,"#032a3b"),ctx.fillStyle=o,ctx.fillRect(0,0,e,a);const{left:c,right:l,top:d,bottom:r,width:i,height:n}=tableCoords(e,a);ctx.save(),ctx.translate(c+i/2,(d+r)/2+.05*n);const p=1.04*i,s=1.12*n,x=ctx.createRadialGradient(0,0,.02*p,0,0,.6*p);x.addColorStop(0,"rgba(0,0,0,0.55)"),x.addColorStop(1,"rgba(0,0,0,0)"),ctx.fillStyle=x,ctx.beginPath(),ctx.ellipse(0,0,p/2,s/4,0,0,2*Math.PI),ctx.fill(),ctx.restore();const h=ctx.createLinearGradient(0,d,0,r);h.addColorStop(0,"#56ccf2"),h.addColorStop(1,"#0077b6"),ctx.fillStyle=h,roundRect(ctx,c,d,i,n,26),ctx.fill(),ctx.lineWidth=6,ctx.strokeStyle="rgba(255,255,255,0.08)",roundRect(ctx,c+3,d+3,i-6,n-6,22),ctx.stroke(),ctx.beginPath(),ctx.moveTo(c+i/2,d+12),ctx.lineTo(c+i/2,r-12),ctx.strokeStyle="rgba(255,255,255,0.06)",ctx.lineWidth=3,ctx.stroke();const y=.25*i,u=.7*n,k=(d+r)/2-u/2;ctx.strokeStyle="rgba(255, 255, 255, 0.15)",ctx.lineWidth=2,roundRect(ctx,c,k,y,u,15),ctx.stroke(),roundRect(ctx,l-y,k,y,u,15),ctx.stroke();ctx.fillStyle="rgba(153,255,153,0.18)",ctx.beginPath(),ctx.arc(c+.25*i,(d+r)/2,30,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc(l-.25*i,(d+r)/2,30,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc((c+l)/2,(d+r)/2,.1*i,0,2*Math.PI),ctx.strokeStyle="rgba(255,255,255,0.1)",ctx.stroke();const v=(puck?.r||12)+20;ctx.setLineDash([8,10]),ctx.strokeStyle="rgba(255, 100, 100, 0.6)",ctx.lineWidth=3,ctx.beginPath(),ctx.arc(c,d,v,0,.5*Math.PI),ctx.stroke(),ctx.beginPath(),ctx.arc(c,r,v,.5*-Math.PI,0),ctx.stroke(),ctx.beginPath(),ctx.arc(l,d,v,.5*Math.PI,Math.PI),ctx.stroke(),ctx.beginPath(),ctx.arc(l,r,v,Math.PI,1.5*Math.PI),ctx.stroke(),ctx.setLineDash([]);const g=Math.min(160,.32*n),m=(d+r)/2-g/2;if(ctx.fillStyle="rgba(0,0,0,0.12)",roundRect(ctx,c-6,m,12,g,6),ctx.fill(),ctx.fillStyle="rgba(153,255,153,0.6)",roundRect(ctx,c,m,6,g,4),ctx.fill(),ctx.fillStyle="rgba(153,255,153,0.6)",roundRect(ctx,l-6,m,6,g,6),ctx.fill(),drawPaddle(paddleA,"#ff6b6b","#731010",t),drawPaddle(paddleB,"#ffd166","#6a4f00",t),drawPuck(),flashTimer>0){const e=flashTimer/.5;ctx.fillStyle=`rgba(255, 255, 255, ${.7*e})`;const a="A"===flashSide?l:c-20;roundRect(ctx,a,m,20,g,6),ctx.fill(),flashTimer-=t}}