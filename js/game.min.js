function resetObjects(){const{left:t,right:e,top:a,bottom:c,width:o}=tableCoords(canvas.width,canvas.height);puck={x:(t+e)/2,y:(a+c)/2,r:Math.max(12,Math.min(28,.02*o)),vx:0,vy:0,mass:1,maxSpeed:1500,rotation:0,angularVelocity:0},paddleA={x:t+.15*o,y:(a+c)/2,r:Math.max(22,Math.min(44,.03*o)),mass:5,maxSpeed:900,acceleration:3500,vx:0,vy:0,hitAnimation:0,isTurboActive:!1},paddleB={x:e-.15*o,y:(a+c)/2,r:Math.max(22,Math.min(44,.03*o)),mass:5,maxSpeed:900,acceleration:3500,vx:0,vy:0,hitAnimation:0,isTurboActive:!1},lastTouch=null}function attemptShoot(t,e={}){const a=e.who||"B";if("A"===a&&"twoPlayer"!==state.gameMode&&shoot.cooldownA>0||"B"===a&&shoot.cooldownB>0||"AI"===a&&shoot.aiCooldown>0)return;if(distance(puck,t)>t.r+puck.r+shoot.distance)return;let c,o=e.targetVec?normalize(e.targetVec):normalize({x:puck.x-t.x,y:puck.y-t.y});if("AI"===a)c=shoot.powerAI;else{const e=Math.hypot(t.vx,t.vy);c=shoot.basePowerHuman+e*shoot.velocityPowerMultiplier,t.isTurboActive&&(c*=turbo.powerMultiplier)}const l=.18;puck.vx=puck.vx*l+o.x*c*(1-l),puck.vy=puck.vy*l+o.y*c*(1-l);const d=Math.hypot(puck.vx,puck.vy),i=1.1*puck.maxSpeed;if(d>i){const t=i/d;puck.vx*=t,puck.vy*=t}puck.angularVelocity+=.002*(t.vx*o.y-t.vy*o.x)+(.4*Math.random()-.2),playShoot(),shakeTimer=.22,shakeIntensity=3+c/shoot.powerAI*6,"A"===a&&(shoot.cooldownA=shoot.cooldownHuman),"B"===a&&(shoot.cooldownB=shoot.cooldownHuman),"AI"===a&&(shoot.aiCooldown=shoot.cooldownAI)}function handleShootKeydown(t){state.running&&("ControlRight"===t.code&&attemptShoot(paddleB,{who:"B"}),t.key&&"f"===t.key.toLowerCase()&&"twoPlayer"===state.gameMode&&attemptShoot(paddleA,{who:"A"}))}function handleGamepadInput(t){const e=navigator.getGamepads?navigator.getGamepads():[];if(!e.length)return;const a=(e,a)=>{if(!a)return;let c=e.acceleration;e.isTurboActive&&(c*=turbo.accelerationMultiplier);let o=a.axes[0],l=a.axes[1];Math.abs(o)<.1&&(o=0),Math.abs(l)<.1&&(l=0),e.vx+=o*c*t,e.vy+=l*c*t;const d=prevPad[a.index]?.buttons?.[0]||!1,i=!!a.buttons?.[0]?.pressed;if(i&&!d){attemptShoot(e,{who:e===paddleA?"A":"B"})}prevPad[a.index]=prevPad[a.index]||{buttons:[]},prevPad[a.index].buttons[0]=i},c=e[1]||e[0];if(a(paddleB,c),"twoPlayer"===state.gameMode){const t=e[0];!t||c&&t.index===c.index||a(paddleA,t)}}let lastAction=0;function getGameState(){const{left:t,right:e,top:a,bottom:c,width:o,height:l}=tableCoords(canvas.width,canvas.height);return[(puck.x-(t+o/2))/(o/2),(puck.y-(a+l/2))/(l/2),puck.vx/puck.maxSpeed,puck.vy/puck.maxSpeed,(paddleA.x-(t+o/4))/(o/4),(paddleA.y-(a+l/2))/(l/2),(paddleB.x-(e-o/4))/(o/4),(paddleB.y-(a+l/2))/(l/2)]}function aiControlRL(t){const e=getGameState(),a=rlAgent.chooseAction(e);lastAction=a;const c=paddleA.acceleration*t;switch(a){case 0:paddleA.vy-=c;break;case 1:paddleA.vy+=c;break;case 2:paddleA.vx-=c;break;case 3:paddleA.vx+=c;break;case 4:attemptShoot(paddleA,{who:"AI"})}}function triggerPenalty(t){if(!state.running)return;const{left:e,right:a}=tableCoords(canvas.width,canvas.height);let c=t||(puck.x>(e+a)/2?"B":"A");state.penaltyFor||(showMessage("اوت","white"),playWhistle()),state.penaltyFor=c,puck.vx=puck.vy=puck.angularVelocity=0;const{top:o,bottom:l,width:d}=tableCoords(canvas.width,canvas.height),i=(o+l)/2;"A"===c?(puck.x=a-.25*d,paddleB.x=a-.15*d):puck.x=e+.25*d,paddleA.x=e+.15*d,puck.y=paddleA.y=paddleB.y=i,paddleA.vx=paddleA.vy=paddleB.vx=paddleB.vy=0}function stepPhysics(t){const{left:e,right:a,top:c,bottom:o,width:l,height:d}=tableCoords(canvas.width,canvas.height),i=navigator.getGamepads?navigator.getGamepads():[],r=i[1]||i[0],p="twoPlayer"===state.gameMode&&i[0]?i[0]:null;if(paddleB){const t=!!r&&!!r.buttons?.[5]?.pressed,e=!!keys.ShiftRight;paddleB.isTurboActive=t||e}if(paddleA&&"twoPlayer"===state.gameMode){const t=!!(p&&(!r||p.index!==r.index))&&!!p.buttons?.[5]?.pressed,e=!!keys.ShiftLeft;paddleA.isTurboActive=t||e}const n=puck.r+20;if(distance(puck,{x:e,y:c})<n||distance(puck,{x:e,y:o})<n||distance(puck,{x:a,y:c})<n||distance(puck,{x:a,y:o})<n)return void triggerPenalty(lastTouch);const s=(e,a,c,o,l)=>{paddleA,paddleA;if("A"===state.penaltyFor&&e===paddleA||"B"===state.penaltyFor&&e===paddleB)e.vx*=.9,e.vy*=.9;else{let d=e.acceleration,i=e.maxSpeed;e.isTurboActive&&(d*=turbo.accelerationMultiplier,i*=turbo.maxSpeedMultiplier);let r=0,p=0;if(keys[a]&&(p-=1),keys[c]&&(p+=1),keys[o]&&(r-=1),keys[l]&&(r+=1),0!==r||0!==p){const a=Math.hypot(r,p);e.vx+=r/a*d*t,e.vy+=p/a*d*t}else e.vx*=.94,e.vy*=.94;const n=Math.hypot(e.vx,e.vy);if(n>i){const t=i/n;e.vx*=t,e.vy*=t}}};"twoPlayer"===state.gameMode?(s(paddleA,"w","s","a","d"),paddleA.x+=paddleA.vx*t,paddleA.y+=paddleA.vy*t,paddleA.x=clamp(paddleA.x,e+paddleA.r,e+l/2-paddleA.r),paddleA.y=clamp(paddleA.y,c+paddleA.r,o-paddleA.r)):(aiControlRL(t),paddleA.x+=paddleA.vx*t,paddleA.y+=paddleA.vy*t,paddleA.vx*=.92,paddleA.vy*=.92,paddleA.x=clamp(paddleA.x,e+paddleA.r,e+l/2-paddleA.r),paddleA.y=clamp(paddleA.y,c+paddleA.r,o-paddleA.r)),s(paddleB,"arrowup","arrowdown","arrowleft","arrowright"),paddleB.x+=paddleB.vx*t,paddleB.y+=paddleB.vy*t,paddleB.x=clamp(paddleB.x,e+l/2+paddleB.r,a-paddleB.r),paddleB.y=clamp(paddleB.y,c+paddleB.r,o-paddleB.r),puck.x+=puck.vx*t,puck.y+=puck.vy*t,puck.rotation+=puck.angularVelocity*t;const x=.995**(60*t);puck.vx*=x,puck.vy*=x,puck.angularVelocity*=x,puck.y-puck.r<c&&(puck.y=c+puck.r,puck.vy*=-.9,playClick(600)),puck.y+puck.r>o&&(puck.y=o-puck.r,puck.vy*=-.9,playClick(600));const h=Math.min(160,.32*d),u=(c+o)/2-h/2,y=(c+o)/2+h/2;puck.x-puck.r<=e&&(puck.y>u&&puck.y<y?scorePoint("B"):(puck.x=e+puck.r,puck.vx*=-.9,playClick(440))),puck.x+puck.r>=a&&(puck.y>u&&puck.y<y?scorePoint("A"):(puck.x=a-puck.r,puck.vx*=-.9,playClick(440)));const k=t=>{const e=puck.x-t.x,a=puck.y-t.y,c=Math.hypot(e,a),o=puck.r+t.r;if(c<o){t.hitAnimation=.2,playClick(1200,.05,.15),lastTouch=t===paddleA?"A":"B",state.penaltyFor&&("A"===state.penaltyFor&&t===paddleB||"B"===state.penaltyFor&&t===paddleA)&&(state.penaltyFor=null);const l=e/c,d=a/c;puck.x=t.x+l*o,puck.y=t.y+d*o;const i=(puck.vx-t.vx)*l+(puck.vy-t.vy)*d;if(i<0){const e=-1.3*i/(1/puck.mass+1/t.mass);puck.vx+=e*l/puck.mass,puck.vy+=e*d/puck.mass,puck.angularVelocity+=.002*(t.vx*d-t.vy*l);const a=Math.hypot(puck.vx,puck.vy);if(a>puck.maxSpeed){const t=puck.maxSpeed/a;puck.vx*=t,puck.vy*=t}}}};k(paddleA),k(paddleB),shoot.cooldownA=Math.max(0,shoot.cooldownA-t),shoot.cooldownB=Math.max(0,shoot.cooldownB-t)}function scorePoint(t){if(!state.running)return;if("A"===t?state.scoreA++:state.scoreB++,scoreAEl.textContent=state.scoreA,scoreBEl.textContent=state.scoreB,state.goldenGoal)return void endMatch();flashTimer=.5,flashSide=t,shakeTimer=.3,shakeIntensity=5,playCheer(.1),playWhistle();if(lastTouch&&lastTouch!==t)showMessage('<div style="text-align:center"><div id="lottieEmoji" style="width:100px; height:100px; margin:0 auto; display:block;"></div><div style="font-size:40px; margin-top:80px;">گل به خودی</div></div>',"white",!0);else{const e="A"===t?"#ff6b6b":"#ffd166";showMessage(String("A"===t?state.scoreA:state.scoreB),e)}const{left:e,right:a,top:c,bottom:o}=tableCoords(canvas.width,canvas.height);puck.x=(e+a)/2,puck.y=(c+o)/2,puck.vx="A"===t?-260:260,puck.vy=0,puck.angularVelocity=0,shoot.aiCooldown=.5,lastTouch=null}function drawPaddle(t,e,a,c){let o=t.r;if(t.hitAnimation>0){const e=1-t.hitAnimation/.2;o=t.r*(1+.2*Math.sin(e*Math.PI)),t.hitAnimation-=c}else t.hitAnimation=0;if(t.isTurboActive){ctx.beginPath(),ctx.arc(t.x,t.y,1.5*o,0,2*Math.PI);const a=ctx.createRadialGradient(t.x,t.y,o,t.x,t.y,1.5*o);a.addColorStop(0,`${e}88`),a.addColorStop(1,`${e}00`),ctx.fillStyle=a,ctx.fill()}const l=6+t.vx/t.maxSpeed*4,d=10+t.vy/t.maxSpeed*4;ctx.beginPath(),ctx.ellipse(t.x+l,t.y+d,1.1*o,.5*o,0,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.25)",ctx.fill(),ctx.beginPath(),ctx.arc(t.x,t.y,o,0,2*Math.PI);const i=ctx.createRadialGradient(t.x-.4*o,t.y-.4*o,.1*o,t.x,t.y,o);i.addColorStop(0,"rgba(255,255,255,0.8)"),i.addColorStop(.3,e),i.addColorStop(1,a),ctx.fillStyle=i,ctx.fill(),ctx.beginPath(),ctx.arc(t.x-.2*o,t.y-.2*o,.5*o,0,2*Math.PI);const r=ctx.createRadialGradient(t.x-.3*o,t.y-.3*o,0,t.x-.2*o,t.y-.2*o,.5*o);r.addColorStop(0,"rgba(255,255,255,0.7)"),r.addColorStop(1,"rgba(255,255,255,0)"),ctx.fillStyle=r,ctx.fill(),ctx.beginPath(),ctx.arc(t.x,t.y,o,0,2*Math.PI),ctx.strokeStyle="rgba(0,0,0,0.2)",ctx.lineWidth=3,ctx.stroke()}function drawPuck(){const t=4+puck.vx/puck.maxSpeed*6,e=8+puck.vy/puck.maxSpeed*6;ctx.beginPath(),ctx.ellipse(puck.x+t,puck.y+e,1.2*puck.r,.5*puck.r,0,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.26)",ctx.fill(),ctx.save(),ctx.translate(puck.x,puck.y),ctx.rotate(puck.rotation),ctx.beginPath(),ctx.arc(0,0,puck.r,0,2*Math.PI);const a=ctx.createRadialGradient(.3*-puck.r,.3*-puck.r,0,0,0,puck.r);a.addColorStop(0,"#f0f0f0"),a.addColorStop(.5,"#444"),a.addColorStop(1,"#111"),ctx.fillStyle=a,ctx.fill(),ctx.beginPath(),ctx.arc(0,0,puck.r,0,2*Math.PI),ctx.lineWidth=2,ctx.strokeStyle="rgba(0,0,0,0.4)",ctx.stroke(),ctx.beginPath(),ctx.arc(0,0,.6*puck.r,0,2*Math.PI),ctx.strokeStyle="rgba(255,255,255,0.2)",ctx.lineWidth=1.5,ctx.stroke(),ctx.restore()}function draw(t){const e=canvas.width,a=canvas.height;ctx.clearRect(0,0,e,a);const c=ctx.createLinearGradient(0,0,0,a);c.addColorStop(0,"#011121"),c.addColorStop(1,"#032a3b"),ctx.fillStyle=c,ctx.fillRect(0,0,e,a);const{left:o,right:l,top:d,bottom:i,width:r,height:p}=tableCoords(e,a);ctx.save(),ctx.translate(o+r/2,(d+i)/2+.05*p);const n=1.04*r,s=1.12*p,x=ctx.createRadialGradient(0,0,.02*n,0,0,.6*n);x.addColorStop(0,"rgba(0,0,0,0.55)"),x.addColorStop(1,"rgba(0,0,0,0)"),ctx.fillStyle=x,ctx.beginPath(),ctx.ellipse(0,0,n/2,s/4,0,0,2*Math.PI),ctx.fill(),ctx.restore();const h=ctx.createLinearGradient(0,d,0,i);h.addColorStop(0,"#56ccf2"),h.addColorStop(1,"#0077b6"),ctx.fillStyle=h,roundRect(ctx,o,d,r,p,26),ctx.fill(),ctx.lineWidth=6,ctx.strokeStyle="rgba(255,255,255,0.08)",roundRect(ctx,o+3,d+3,r-6,p-6,22),ctx.stroke(),ctx.beginPath(),ctx.moveTo(o+r/2,d+12),ctx.lineTo(o+r/2,i-12),ctx.strokeStyle="rgba(255,255,255,0.06)",ctx.lineWidth=3,ctx.stroke();const u=.25*r,y=.7*p,k=(d+i)/2-y/2;ctx.strokeStyle="rgba(255, 255, 255, 0.15)",ctx.lineWidth=2,roundRect(ctx,o,k,u,y,15),ctx.stroke(),roundRect(ctx,l-u,k,u,y,15),ctx.stroke();ctx.fillStyle="rgba(153,255,153,0.18)",ctx.beginPath(),ctx.arc(o+.25*r,(d+i)/2,30,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc(l-.25*r,(d+i)/2,30,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc((o+l)/2,(d+i)/2,.1*r,0,2*Math.PI),ctx.strokeStyle="rgba(255,255,255,0.1)",ctx.stroke();const v=(puck?.r||12)+20;ctx.setLineDash([8,10]),ctx.strokeStyle="rgba(255, 100, 100, 0.6)",ctx.lineWidth=3,ctx.beginPath(),ctx.arc(o,d,v,0,.5*Math.PI),ctx.stroke(),ctx.beginPath(),ctx.arc(o,i,v,.5*-Math.PI,0),ctx.stroke(),ctx.beginPath(),ctx.arc(l,d,v,.5*Math.PI,Math.PI),ctx.stroke(),ctx.beginPath(),ctx.arc(l,i,v,Math.PI,1.5*Math.PI),ctx.stroke(),ctx.setLineDash([]);const A=Math.min(160,.32*p),g=(d+i)/2-A/2;if(ctx.fillStyle="rgba(0,0,0,0.12)",roundRect(ctx,o-6,g,12,A,6),ctx.fill(),ctx.fillStyle="rgba(153,255,153,0.6)",roundRect(ctx,o,g,6,A,4),ctx.fill(),ctx.fillStyle="rgba(153,255,153,0.6)",roundRect(ctx,l-6,g,6,A,6),ctx.fill(),drawPaddle(paddleA,"#ff6b6b","#731010",t),drawPaddle(paddleB,"#ffd166","#6a4f00",t),drawPuck(),flashTimer>0){const e=flashTimer/.5;ctx.fillStyle=`rgba(255, 255, 255, ${.7*e})`;const a="A"===flashSide?l:o-20;roundRect(ctx,a,g,20,A,6),ctx.fill(),flashTimer-=t}}