function resetObjects(){const{left:t,right:e,top:a,bottom:o,width:c}=tableCoords(canvas.width,canvas.height);puck={x:(t+e)/2,y:(a+o)/2,r:Math.max(12,Math.min(28,.02*c)),vx:0,vy:0,mass:1,maxSpeed:1500,rotation:0,angularVelocity:0},paddleA={x:t+.15*c,y:(a+o)/2,r:Math.max(22,Math.min(44,.03*c)),mass:5,maxSpeed:900,acceleration:3500,vx:0,vy:0,hitAnimation:0,isTurboActive:!1},paddleB={x:e-.15*c,y:(a+o)/2,r:Math.max(22,Math.min(44,.03*c)),mass:5,maxSpeed:900,acceleration:3500,vx:0,vy:0,hitAnimation:0,isTurboActive:!1},lastTouch=null}function attemptShoot(t,e={}){const a=e.who||"B";if("A"===a&&"twoPlayer"!==state.gameMode||"A"===a&&shoot.cooldownA>0||"B"===a&&shoot.cooldownB>0||"AI"===a&&shoot.aiCooldown>0)return;if(distance(puck,t)>t.r+puck.r+shoot.distance)return;let o,c=e.targetVec?normalize(e.targetVec):normalize({x:puck.x-t.x,y:puck.y-t.y});if("AI"===a)o=shoot.powerAI;else{const e=Math.hypot(t.vx,t.vy);o=shoot.basePowerHuman+e*shoot.velocityPowerMultiplier,t.isTurboActive&&(o*=turbo.powerMultiplier)}const l=.18;puck.vx=puck.vx*l+c.x*o*(1-l),puck.vy=puck.vy*l+c.y*o*(1-l);const r=Math.hypot(puck.vx,t.vy),n=1.1*puck.maxSpeed;if(r>n){const t=n/r;puck.vx*=t,puck.vy*=t}puck.angularVelocity+=.002*(t.vx*c.y-t.vy*c.x)+(.4*Math.random()-.2),playShoot(),shakeTimer=.22,shakeIntensity=3+o/shoot.powerAI*6,"A"===a&&(shoot.cooldownA=shoot.cooldownHuman),"B"===a&&(shoot.cooldownB=shoot.cooldownHuman),"AI"===a&&(shoot.aiCooldown=shoot.cooldownAI)}function handleShootKeydown(t){state.running&&("ControlRight"===t.code&&attemptShoot(paddleB,{who:"B"}),t.key&&"f"===t.key.toLowerCase()&&"twoPlayer"===state.gameMode&&attemptShoot(paddleA,{who:"A"}))}function handleGamepadInput(t){const e=navigator.getGamepads?navigator.getGamepads():[];if(!e.length)return;const a=(e,a)=>{if(!a)return;let o=e.acceleration;e.isTurboActive&&(o*=turbo.accelerationMultiplier);let c=a.axes[0],l=a.axes[1];Math.abs(c)<.1&&(c=0),Math.abs(l)<.1&&(l=0),e.vx+=c*o*t,e.vy+=l*o*t;const r=prevPad[a.index]?.buttons?.[0]||!1,n=!!a.buttons?.[0]?.pressed;if(n&&!r){attemptShoot(e,{who:e===paddleA?"A":"B"})}prevPad[a.index]=prevPad[a.index]||{buttons:[]},prevPad[a.index].buttons[0]=n},o=e[1]||e[0];if(a(paddleB,o),"twoPlayer"===state.gameMode){const t=e[0];!t||o&&t.index===o.index||a(paddleA,t)}}function moveTowards(t,e,a,o,c=1){const l=e.x-t.x,r=e.y-t.y,n=Math.hypot(l,r);n>1&&(t.vx+=l/n*a*o*8*(c||1),t.vy+=r/n*a*o*8*(c||1)),t.vx*=.9,t.vy*=.9;const i=Math.hypot(t.vx,t.vy);if(i>a){const e=a/i;t.vx*=e,t.vy*=e}t.x+=t.vx*o,t.y+=t.vy*o}function calculateBankShotTarget(){const{left:t,right:e,top:a,bottom:o,width:c,height:l}=tableCoords(canvas.width,canvas.height),r=(paddleA,{x:e-10,y:(a+o)/2});if(!(Math.abs(puck.y-paddleB.y)<paddleB.r&&puck.x<paddleB.x))return null;const n=[{y:a,name:"top"},{y:o,name:"bottom"}];let i=null,s=-1/0;for(const a of n){const o=a.y+(a.y-r.y),c={x:r.x,y:o},l=normalize({x:c.x-puck.x,y:c.y-puck.y}),n=(a.y-puck.y)/l.y;if(n>0){const o={x:puck.x+l.x*n,y:a.y};if(o.x>t&&o.x<e){const t=Math.abs(l.x);t>s&&(s=t,i=o)}}}return i}function aiControl(t){const{left:e,right:a,top:o,bottom:c,width:l,height:r}=tableCoords(canvas.width,canvas.height),n=paddleA,i=Math.min(160,.32*r),s=(o+c)/2-i/2,x=(o+c)/2+i/2,d={x:a-10,y:(o+c)/2},p=puck.x<e+.55*l,h=()=>{n.x=Math.max(e+n.r,Math.min(e+l/2-n.r,n.x)),n.y=Math.max(o+n.r,Math.min(c-n.r,n.y))},y=e+.14*l,u=.9*n.maxSpeed;shoot.aiCooldown=Math.max(0,shoot.aiCooldown-t);const k={x:puck.x+.15*puck.vx,y:puck.y+.15*puck.vy};if(!p&&"B"!==state.penaltyFor){const e={x:y,y:clamp(k.y,o+n.r,c-n.r)};return moveTowards(n,e,u,t),void h()}let v=null,f=!1;const g=calculateBankShotTarget();if(g&&"B"!==state.penaltyFor&&Math.random()<.4)v=g,f=!0;else{let t;t=(paddleB.y-s)/i<.5?d.y+i/4+Math.random()*(i/4):d.y-i/4-Math.random()*(i/4);const e=clamp(t,s+12,x-12);v={x:d.x,y:e}}const m=normalize({x:v.x-k.x,y:v.y-k.y}),b=n.r+puck.r+(f?15:24),w={x:k.x-m.x*b,y:k.y-m.y*b};if(w.x=clamp(w.x,e+n.r,e+l/2-n.r),w.y=clamp(w.y,o+n.r,c-n.r),distance(n,w)>8)moveTowards(n,w,u,t,1.2);else{const e={x:k.x-m.x*(n.r+6),y:k.y-m.y*(n.r+6)};moveTowards(n,e,1.15*u,t,1.6);const a=normalize({x:puck.x-n.x,y:puck.y-n.y}),o=dot(a,m);distance(n,puck)<=n.r+puck.r+shoot.distance+6&&o>(f?.45:.55)&&shoot.aiCooldown<=0&&attemptShoot(n,{who:"AI",targetVec:m,power:shoot.powerAI*(f?1.1:1)})}h()}function triggerPenalty(t){if(!state.running)return;const{left:e,right:a}=tableCoords(canvas.width,canvas.height);let o=t;o||(o=puck.x>(e+a)/2?"B":"A"),state.penaltyFor||(showMessage("اوت","white"),playWhistle()),state.penaltyFor=o,puck.vx=puck.vy=puck.angularVelocity=0;const{top:c,bottom:l,width:r}=tableCoords(canvas.width,canvas.height),n=(c+l)/2;"A"===o?(puck.x=a-.25*r,paddleB.x=a-.15*r,paddleA.x=e+.15*r):(puck.x=e+.25*r,paddleA.x=e+.15*r,paddleB.x=a-.15*r),puck.y=paddleA.y=paddleB.y=n,paddleA.vx=paddleA.vy=paddleB.vx=paddleB.vy=0}function stepPhysics(t){const{left:e,right:a,top:o,bottom:c,width:l,height:r}=tableCoords(canvas.width,canvas.height),n=navigator.getGamepads?navigator.getGamepads():[],i=n[1]||n[0],s="twoPlayer"===state.gameMode&&n[0]?n[0]:null;if(paddleB){const t=!!i&&!!i.buttons?.[5]?.pressed,e=!!keys.ShiftRight;paddleB.isTurboActive=t||e}if(paddleA){const t=s&&(!i||s.index!==i.index);if("twoPlayer"===state.gameMode){const e=!!t&&!!s.buttons?.[5]?.pressed,a=!!keys.ShiftLeft;paddleA.isTurboActive=e||a}else paddleA.isTurboActive=!1}const x=puck.r+20;if(distance(puck,{x:e,y:o})<x||distance(puck,{x:e,y:c})<x||distance(puck,{x:a,y:o})<x||distance(puck,{x:a,y:c})<x)return void triggerPenalty(lastTouch);const d=(r,n,i,s,x)=>{const d=r===paddleA?e+8:e+l/2+8,p=r===paddleA?e+l/2-8:a-8;if("A"===state.penaltyFor&&r===paddleA||"B"===state.penaltyFor&&r===paddleB)r.vx*=.9,r.vy*=.9;else{let e=r.acceleration,a=r.maxSpeed;r.isTurboActive&&(e*=turbo.accelerationMultiplier,a*=turbo.maxSpeedMultiplier);let o=0,c=0;if(keys[n]&&(c-=1),keys[i]&&(c+=1),keys[s]&&(o-=1),keys[x]&&(o+=1),0!==o||0!==c){const a=Math.hypot(o,c);r.vx+=o/a*e*t,r.vy+=c/a*e*t}else r.vx*=.94,r.vy*=.94;const l=Math.hypot(r.vx,r.vy);if(l>a){const t=a/l;r.vx*=t,r.vy*=t}}r.x+=r.vx*t,r.y+=r.vy*t,r.x=clamp(r.x,d+r.r,p-r.r),r.y=clamp(r.y,o+r.r,c-r.r)};"twoPlayer"===state.gameMode?d(paddleA,"w","s","a","d"):aiControl(t),d(paddleB,"arrowup","arrowdown","arrowleft","arrowright"),puck.x+=puck.vx*t,puck.y+=puck.vy*t,puck.rotation+=puck.angularVelocity*t;const p=.995**(60*t);puck.vx*=p,puck.vy*=p,puck.angularVelocity*=p,puck.y-puck.r<o&&(puck.y=o+puck.r,puck.vy*=-.9,playClick(600)),puck.y+puck.r>c&&(puck.y=c-puck.r,puck.vy*=-.9,playClick(600));const h=Math.min(160,.32*r),y=(o+c)/2-h/2,u=(o+c)/2+h/2;puck.x-puck.r<=e&&(puck.y>y&&puck.y<u?scorePoint("B"):(puck.x=e+puck.r,puck.vx*=-.9,playClick(440))),puck.x+puck.r>=a&&(puck.y>y&&puck.y<u?scorePoint("A"):(puck.x=a-puck.r,puck.vx*=-.9,playClick(440)));const k=t=>{const e=puck.x-t.x,a=puck.y-t.y,o=Math.hypot(e,a),c=puck.r+t.r;if(o<c){t.hitAnimation=.2,playClick(1200,.05,.15),lastTouch=t===paddleA?"A":"B",state.penaltyFor&&("A"===state.penaltyFor&&t===paddleB||"B"===state.penaltyFor&&t===paddleA)&&(state.penaltyFor=null);const l=e/o,r=a/o;puck.x=t.x+l*c,puck.y=t.y+r*c;const n=(puck.vx-t.vx)*l+(puck.vy-t.vy)*r;if(n<0){const e=-1.3*n/(1/puck.mass+1/t.mass);puck.vx+=e*l/puck.mass,puck.vy+=e*r/puck.mass,puck.angularVelocity+=.002*(t.vx*r-t.vy*l);const a=Math.hypot(puck.vx,puck.vy);if(a>puck.maxSpeed){const t=puck.maxSpeed/a;puck.vx*=t,puck.vy*=t}}}};k(paddleA),k(paddleB),shoot.cooldownA=Math.max(0,shoot.cooldownA-t),shoot.cooldownB=Math.max(0,shoot.cooldownB-t)}function scorePoint(t){if(!state.running)return;if("A"===t?state.scoreA++:state.scoreB++,scoreAEl.textContent=state.scoreA,scoreBEl.textContent=state.scoreB,state.goldenGoal)return void endMatch();flashTimer=.5,flashSide=t,shakeTimer=.3,shakeIntensity=5,playCheer(.1),playWhistle();if(lastTouch&&lastTouch!==t)showMessage('<div style="text-align:center"><div id="lottieEmoji" style="width:100px; height:100px; margin:0 auto; display:block;"></div><div style="font-size:40px; margin-top:80px;">گل به خودی</div></div>',"white",!0);else{const e="A"===t?"#ff6b6b":"#ffd166";showMessage(String("A"===t?state.scoreA:state.scoreB),e)}const{left:e,right:a,top:o,bottom:c}=tableCoords(canvas.width,canvas.height);puck.x=(e+a)/2,puck.y=(o+c)/2,puck.vx="A"===t?-260:260,puck.vy=0,puck.angularVelocity=0,shoot.aiCooldown=.5,lastTouch=null}function drawPaddle(t,e,a,o){let c=t.r;if(t.hitAnimation>0){const e=1-t.hitAnimation/.2;c=t.r*(1+.2*Math.sin(e*Math.PI)),t.hitAnimation-=o}else t.hitAnimation=0;if(t.isTurboActive){ctx.beginPath(),ctx.arc(t.x,t.y,1.5*c,0,2*Math.PI);const a=ctx.createRadialGradient(t.x,t.y,c,t.x,t.y,1.5*c);a.addColorStop(0,`${e}88`),a.addColorStop(1,`${e}00`),ctx.fillStyle=a,ctx.fill()}const l=6+t.vx/t.maxSpeed*4,r=10+t.vy/t.maxSpeed*4;ctx.beginPath(),ctx.ellipse(t.x+l,t.y+r,1.1*c,.5*c,0,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.25)",ctx.fill(),ctx.beginPath(),ctx.arc(t.x,t.y,c,0,2*Math.PI);const n=ctx.createRadialGradient(t.x-.4*c,t.y-.4*c,.1*c,t.x,t.y,c);n.addColorStop(0,"rgba(255,255,255,0.8)"),n.addColorStop(.3,e),n.addColorStop(1,a),ctx.fillStyle=n,ctx.fill(),ctx.beginPath(),ctx.arc(t.x-.2*c,t.y-.2*c,.5*c,0,2*Math.PI);const i=ctx.createRadialGradient(t.x-.3*c,t.y-.3*c,0,t.x-.2*c,t.y-.2*c,.5*c);i.addColorStop(0,"rgba(255,255,255,0.7)"),i.addColorStop(1,"rgba(255,255,255,0)"),ctx.fillStyle=i,ctx.fill(),ctx.beginPath(),ctx.arc(t.x,t.y,c,0,2*Math.PI),ctx.strokeStyle="rgba(0,0,0,0.2)",ctx.lineWidth=3,ctx.stroke()}function drawPuck(){const t=4+puck.vx/puck.maxSpeed*6,e=8+puck.vy/puck.maxSpeed*6;ctx.beginPath(),ctx.ellipse(puck.x+t,puck.y+e,1.2*puck.r,.5*puck.r,0,0,2*Math.PI),ctx.fillStyle="rgba(0,0,0,0.26)",ctx.fill(),ctx.save(),ctx.translate(puck.x,puck.y),ctx.rotate(puck.rotation),ctx.beginPath(),ctx.arc(0,0,puck.r,0,2*Math.PI);const a=ctx.createRadialGradient(.3*-puck.r,.3*-puck.r,0,0,0,puck.r);a.addColorStop(0,"#f0f0f0"),a.addColorStop(.5,"#444"),a.addColorStop(1,"#111"),ctx.fillStyle=a,ctx.fill(),ctx.beginPath(),ctx.arc(0,0,puck.r,0,2*Math.PI),ctx.lineWidth=2,ctx.strokeStyle="rgba(0,0,0,0.4)",ctx.stroke(),ctx.beginPath(),ctx.arc(0,0,.6*puck.r,0,2*Math.PI),ctx.strokeStyle="rgba(255,255,255,0.2)",ctx.lineWidth=1.5,ctx.stroke(),ctx.restore()}function draw(t){const e=canvas.width,a=canvas.height;ctx.clearRect(0,0,e,a);const o=ctx.createLinearGradient(0,0,0,a);o.addColorStop(0,"#011121"),o.addColorStop(1,"#032a3b"),ctx.fillStyle=o,ctx.fillRect(0,0,e,a);const{left:c,right:l,top:r,bottom:n,width:i,height:s}=tableCoords(e,a);ctx.save(),ctx.translate(c+i/2,(r+n)/2+.05*s);const x=1.04*i,d=1.12*s,p=ctx.createRadialGradient(0,0,.02*x,0,0,.6*x);p.addColorStop(0,"rgba(0,0,0,0.55)"),p.addColorStop(1,"rgba(0,0,0,0)"),ctx.fillStyle=p,ctx.beginPath(),ctx.ellipse(0,0,x/2,d/4,0,0,2*Math.PI),ctx.fill(),ctx.restore();const h=ctx.createLinearGradient(0,r,0,n);h.addColorStop(0,"#56ccf2"),h.addColorStop(1,"#0077b6"),ctx.fillStyle=h,roundRect(ctx,c,r,i,s,26),ctx.fill(),ctx.lineWidth=6,ctx.strokeStyle="rgba(255,255,255,0.08)",roundRect(ctx,c+3,r+3,i-6,s-6,22),ctx.stroke(),ctx.beginPath(),ctx.moveTo(c+i/2,r+12),ctx.lineTo(c+i/2,n-12),ctx.strokeStyle="rgba(255,255,255,0.06)",ctx.lineWidth=3,ctx.stroke();const y=.25*i,u=.7*s,k=(r+n)/2-u/2;ctx.strokeStyle="rgba(255, 255, 255, 0.15)",ctx.lineWidth=2,roundRect(ctx,c,k,y,u,15),ctx.stroke(),roundRect(ctx,l-y,k,y,u,15),ctx.stroke();ctx.fillStyle="rgba(153,255,153,0.18)",ctx.beginPath(),ctx.arc(c+.25*i,(r+n)/2,30,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc(l-.25*i,(r+n)/2,30,0,2*Math.PI),ctx.fill(),ctx.beginPath(),ctx.arc((c+l)/2,(r+n)/2,.1*i,0,2*Math.PI),ctx.strokeStyle="rgba(255,255,255,0.1)",ctx.stroke();const v=(puck?.r||12)+20;ctx.setLineDash([8,10]),ctx.strokeStyle="rgba(255, 100, 100, 0.6)",ctx.lineWidth=3,ctx.beginPath(),ctx.arc(c,r,v,0,.5*Math.PI),ctx.stroke(),ctx.beginPath(),ctx.arc(c,n,v,.5*-Math.PI,0),ctx.stroke(),ctx.beginPath(),ctx.arc(l,r,v,.5*Math.PI,Math.PI),ctx.stroke(),ctx.beginPath(),ctx.arc(l,n,v,Math.PI,1.5*Math.PI),ctx.stroke(),ctx.setLineDash([]);const f=Math.min(160,.32*s),g=(r+n)/2-f/2;if(ctx.fillStyle="rgba(0,0,0,0.12)",roundRect(ctx,c-6,g,12,f,6),ctx.fill(),ctx.fillStyle="rgba(255, 0, 0, 0.6)",roundRect(ctx,c,g,6,f,4),ctx.fill(),ctx.fillStyle="rgba(255, 0, 0, 0.6)",roundRect(ctx,l-6,g,6,f,6),ctx.fill(),drawPaddle(paddleA,"#ff6b6b","#731010",t),drawPaddle(paddleB,"#ffd166","#6a4f00",t),drawPuck(),flashTimer>0){const e=flashTimer/.5;ctx.fillStyle=`rgba(255, 255, 255, ${.7*e})`;const a="A"===flashSide?l:c-20;roundRect(ctx,a,g,20,f,6),ctx.fill(),flashTimer-=t}}